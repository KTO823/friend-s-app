<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>GIFTFLOW PRO - Definitive Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* é«˜ç´šæ„ŸèƒŒæ™¯èˆ‡æ¨¡ç³Š */
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(241, 245, 249, 0.5); }
        .safe-bottom { padding-bottom: calc(env(safe-area-inset-bottom) + 24px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* ç©©å®š Toast */
        .toast { position: fixed; top: 32px; left: 50%; transform: translateX(-50%) translateY(-120px); background: rgba(15, 23, 42, 0.95); color: white; padding: 14px 28px; border-radius: 99px; font-size: 13px; font-weight: bold; opacity: 0; transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1); pointer-events: none; z-index: 10000; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        /* æŒ‰éˆ•äº’å‹•åé¥‹ */
        .btn-press { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-press:active { transform: scale(0.95); opacity: 0.8; }
        
        /* éœæ…‹é«˜å„ªå…ˆç´šé‚Šæ¡† (ç„¡é–ƒçˆ) */
        .priority-high-border { border: 2px solid #fb7185; box-shadow: 0 4px 20px rgba(251, 113, 133, 0.1); }
        
        /* è¼‰å…¥å‹•ç•« */
        .spinner { width: 1.25em; height: 1.25em; border: 3px solid rgba(255,255,255,0.2); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* æ»‘å‹•å®¹å™¨ */
        .snap-x-mandatory { scroll-snap-type: x mandatory; }
        .snap-center { scroll-snap-align: center; }

        /* å…±ç”¨å…ƒä»¶æ¨£å¼ */
        .input-field { @apply w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:bg-white focus:border-indigo-600 transition-all font-bold text-sm placeholder:font-normal placeholder:text-slate-400; }
        .modal-overlay { @apply fixed inset-0 z-[60] bg-slate-900/60 backdrop-blur-md flex items-end justify-center p-0 sm:p-4 transition-opacity duration-300; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 overflow-x-hidden select-none">

    <div id="toast" class="toast"></div>

    <!-- ç™»å…¥é é¢ -->
    <div id="login-screen" class="flex flex-col items-center justify-center min-h-screen p-8 relative z-50 bg-slate-50">
        <div class="w-full max-w-md bg-white rounded-[3.5rem] shadow-2xl p-12 text-center border border-slate-100">
            <div class="w-24 h-24 bg-indigo-600 rounded-[2.5rem] mx-auto mb-10 flex items-center justify-center text-white shadow-2xl shadow-indigo-100 transform -rotate-6">
                <i data-lucide="gift" class="w-12 h-12"></i>
            </div>
            <h1 class="text-4xl font-black mb-3 tracking-tighter text-slate-900">GIFTFLOW</h1>
            <p class="text-[10px] font-black text-slate-400 mb-12 uppercase tracking-[0.4em]">Connect â€¢ Gift â€¢ Settle</p>
            
            <form id="auth-form" class="space-y-4 text-left">
                <input type="email" id="email" placeholder="Email Address" class="input-field">
                <input type="password" id="password" placeholder="Secret Password" class="input-field">
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="handleAuth('login', this)" class="flex-1 py-5 bg-slate-900 text-white font-black rounded-[1.5rem] shadow-xl btn-press">ç™»å…¥</button>
                    <button type="button" onclick="handleAuth('signup', this)" class="flex-1 py-5 bg-white border-2 border-slate-100 text-slate-900 font-black rounded-[1.5rem] btn-press">è¨»å†Š</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ä¸»ç¨‹å¼çµæ§‹ -->
    <div id="main-app" class="hidden max-w-md mx-auto min-h-screen flex flex-col">
        <header class="px-6 py-6 sticky top-0 z-40 flex justify-between items-center glass">
            <div class="flex items-center gap-3 cursor-pointer" onclick="switchTab('dashboard')">
                <div class="w-3 h-3 bg-indigo-600 rounded-full"></div>
                <h1 class="text-2xl font-black italic text-indigo-600 tracking-tighter">GIFTFLOW</h1>
            </div>
            <button onclick="switchTab('settings')" class="btn-press">
                <div id="header-avatar" class="w-11 h-11 rounded-full bg-slate-100 border-2 border-white shadow-md ring-4 ring-slate-50 overflow-hidden"></div>
            </button>
        </header>

        <main id="content" class="p-6 flex-1 pb-44 overflow-y-auto hide-scrollbar space-y-10"></main>

        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto glass border-t border-slate-100 px-10 pt-5 pb-10 flex justify-between items-center z-40 safe-bottom">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-btn opacity-30"><i data-lucide="home" class="w-7 h-7"></i></button>
            <button onclick="switchTab('gifts')" id="nav-gifts" class="nav-btn opacity-30"><i data-lucide="gift" class="w-7 h-7"></i></button>
            <div class="relative -top-10">
                <button onclick="openAddModal()" class="bg-indigo-600 text-white p-6 rounded-full shadow-2xl shadow-indigo-300 ring-[10px] ring-white btn-press"><i data-lucide="plus" class="w-8 h-8"></i></button>
            </div>
            <button onclick="switchTab('ledgers')" id="nav-ledgers" class="nav-btn opacity-30"><i data-lucide="credit-card" class="w-7 h-7"></i></button>
            <button onclick="switchTab('settings')" id="nav-settings" class="nav-btn opacity-30"><i data-lucide="user" class="w-7 h-7"></i></button>
        </nav>
    </div>

    <!-- å¤šåŠŸèƒ½è¼¸å…¥å½ˆçª— (é€šç”¨ Modal) -->
    <div id="universal-modal" class="hidden modal-overlay">
        <div class="bg-white w-full max-w-md rounded-t-[3.5rem] sm:rounded-[3.5rem] p-10 shadow-2xl animate-in slide-in-from-bottom duration-500">
            <div class="flex justify-between items-center mb-8">
                <h2 id="modal-title" class="text-2xl font-black text-slate-900 tracking-tight"></h2>
                <button onclick="closeUniversalModal()" class="p-3 bg-slate-50 rounded-full"><i data-lucide="x" class="w-6 h-6 text-slate-400"></i></button>
            </div>
            <div id="modal-fields" class="space-y-5"></div>
            <button id="modal-submit" class="w-full py-5 bg-slate-900 text-white font-black rounded-[1.8rem] shadow-xl mt-8 btn-press">ç¢ºèªæäº¤</button>
        </div>
    </div>

    <!-- åŸæœ‰çš„æ–°å¢é …ç›® Modal (Wishlist/Debt) -->
    <div id="add-modal" class="hidden modal-overlay">
        <div class="bg-white w-full max-w-md rounded-t-[3.5rem] sm:rounded-[3.5rem] p-10 shadow-2xl animate-in slide-in-from-bottom duration-500">
            <div class="flex justify-between items-center mb-10">
                <h2 class="text-2xl font-black text-slate-900 tracking-tight">New Activity</h2>
                <button onclick="closeModal()" class="p-3 bg-slate-50 rounded-full"><i data-lucide="x" class="w-6 h-6 text-slate-400"></i></button>
            </div>
            <div class="flex p-2 bg-slate-100 rounded-3xl mb-8">
                <button onclick="setAddType('wishlist')" id="type-wish" class="flex-1 py-4 rounded-[1.2rem] text-xs font-black bg-white shadow-sm text-indigo-600 transition-all">ğŸ é¡˜æœ›æ¸…å–®</button>
                <button onclick="setAddType('debt')" id="type-debt" class="flex-1 py-4 rounded-[1.2rem] text-xs font-black text-slate-400 transition-all">ğŸ’¸ è¨˜å¸³åˆ†æ”¤</button>
            </div>
            <form id="add-form" class="space-y-6">
                <input type="text" id="add-name" placeholder="é …ç›®åç¨±" required class="input-field">
                <div class="flex gap-4">
                    <input type="number" id="add-amount" placeholder="é‡‘é¡" class="input-field flex-1">
                    <select id="add-priority" class="input-field flex-1 text-xs">
                        <option value="normal">æ¬Šé‡: ä¸€èˆ¬</option>
                        <option value="high">ğŸ”¥ æ¥µåº¦æƒ³è¦</option>
                        <option value="low">â˜• éš¨ç·£</option>
                    </select>
                </div>
                <select id="add-group-id" class="input-field bg-indigo-50/50 text-indigo-600" onchange="loadGroupMembersForDebt(this.value)"></select>
                <div id="debt-options" class="hidden space-y-5 pt-2">
                    <div class="flex gap-4">
                        <button type="button" onclick="setDebtDirection('owe_me')" id="dir-owe-me" class="flex-1 py-4 border-2 border-indigo-600 bg-indigo-50 text-indigo-700 rounded-2xl text-xs font-black transition-all">åˆ¥äººæ¬ æˆ‘</button>
                        <button type="button" onclick="setDebtDirection('i_owe')" id="dir-i-owe" class="flex-1 py-4 border-2 border-slate-100 text-slate-400 rounded-2xl text-xs font-black transition-all">æˆ‘æ¬ åˆ¥äºº</button>
                    </div>
                    <select id="add-target-member" class="input-field text-slate-700"></select>
                </div>
                <button type="button" onclick="handleSubmit(this)" class="w-full py-5 bg-slate-900 text-white font-black rounded-[1.8rem] shadow-xl mt-4 btn-press">ç™¼ä½ˆç´€éŒ„</button>
            </form>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://kzzxyyykpiquanxtfkwr.supabase.co'; 
        const supabaseKey = 'sb_publishable_K0ThQ9_ZqPPYk0sxxWgLhg_qwzuMNeG'; 
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let activeTab = 'dashboard';
        let currentAddType = 'wishlist';
        let debtDirection = 'owe_me';

        // 1. åˆå§‹åŒ–
        window.onload = async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) { currentUser = session.user; showApp(); }
            setupRealtime();
            lucide.createIcons();
        };

        function setupRealtime() {
            _supabase.channel('main-channel').on('postgres_changes', { event: '*', schema: 'public' }, () => renderContent()).subscribe();
        }

        // 2. èº«ä»½é©—è­‰
        async function handleAuth(type, btn) {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            if (!email || !password) return showToast("æ¬„ä½ä¸å¯ç•™ç©º", 'error');

            setLoading(btn, true);
            const res = type === 'login' 
                ? await _supabase.auth.signInWithPassword({ email, password }) 
                : await _supabase.auth.signUp({ email, password });
            setLoading(btn, false);

            if (res.error) showToast(res.error.message, 'error');
            else { currentUser = res.data.user; showApp(); }
        }

        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            updateHeaderAvatar();
            switchTab('dashboard');
            loadGroupsToSelect();
        }

        // 3. å¤šåŠŸèƒ½å½ˆçª—æ§åˆ¶å™¨ (å–ä»£ prompt)
        function showUniversalModal(title, fields, submitCallback) {
            const modal = document.getElementById('universal-modal');
            const titleEl = document.getElementById('modal-title');
            const fieldsContainer = document.getElementById('modal-fields');
            const submitBtn = document.getElementById('modal-submit');

            titleEl.innerText = title;
            fieldsContainer.innerHTML = '';
            
            fields.forEach(f => {
                const label = document.createElement('label');
                label.className = "text-[10px] font-black text-slate-400 uppercase ml-4 mb-2 block tracking-widest";
                label.innerText = f.label;
                
                const input = document.createElement('input');
                input.id = `u-field-${f.id}`;
                input.type = f.type || 'text';
                input.placeholder = f.placeholder;
                input.value = f.value || '';
                input.className = "input-field mb-2";
                
                fieldsContainer.appendChild(label);
                fieldsContainer.appendChild(input);
            });

            submitBtn.onclick = async () => {
                setLoading(submitBtn, true);
                const data = {};
                fields.forEach(f => { data[f.id] = document.getElementById(`u-field-${f.id}`).value; });
                await submitCallback(data);
                setLoading(submitBtn, false);
                closeUniversalModal();
            };

            modal.classList.remove('hidden');
        }

        function closeUniversalModal() { document.getElementById('universal-modal').classList.add('hidden'); }

        // 4. è·¯ç”±åˆ‡æ›
        function switchTab(t) {
            activeTab = t;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.add('opacity-30'));
            document.getElementById('nav-' + t).classList.remove('opacity-30');
            renderContent();
        }

        async function renderContent() {
            const container = document.getElementById('content');
            container.innerHTML = getSkeletonLoader();

            if (activeTab === 'dashboard') await renderDashboard(container);
            else if (activeTab === 'gifts') await renderGifts(container);
            else if (activeTab === 'ledgers') await renderLedgers(container);
            else if (activeTab === 'settings') await renderSettingsPage(container);
            
            lucide.createIcons();
        }

        // 5. å„€è¡¨æ¿
        async function renderDashboard(container) {
            const [membersRes, ledgersRes] = await Promise.all([
                _supabase.from('group_members').select('*, profiles(*)'),
                _supabase.from('ledgers').select('*')
            ]);
            
            if (!membersRes.data || membersRes.data.length === 0) return renderEmpty('å°šç„¡ç¤¾äº¤åœˆ', 'åŠ å…¥æˆ–å»ºç«‹ä¸€å€‹ç¾¤çµ„ä¾†é–‹å§‹ã€‚');

            let rec = 0, pay = 0;
            ledgersRes.data?.forEach(l => {
                if (l.status !== 'settled') {
                    if (l.creditor_id === currentUser.id) rec += l.amount;
                    if (l.debtor_id === currentUser.id) pay += l.amount;
                }
            });

            const friends = membersRes.data
                .filter(m => m.user_id !== currentUser.id)
                .map(m => ({ ...m, days: calculateDays(m.profiles?.birthday) }))
                .sort((a, b) => a.days - b.days);

            container.innerHTML = `
                <div class="flex overflow-x-auto snap-x snap-mandatory gap-4 pb-4 -mx-6 px-6 hide-scrollbar">
                    <div class="snap-center shrink-0 w-[85%] bg-slate-900 text-white p-8 rounded-[3rem] shadow-2xl relative">
                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2">Net Financial Status</p>
                        <h2 class="text-4xl font-black mb-8 tracking-tighter ${rec-pay >= 0 ? 'text-emerald-400' : 'text-rose-400'}">
                            $ ${(rec-pay).toLocaleString()}
                        </h2>
                        <div class="flex gap-8 border-t border-white/10 pt-6">
                            <div><p class="text-[9px] text-slate-500 font-bold uppercase mb-1">Receivable</p><p class="font-black text-emerald-400 text-base">+$${rec.toLocaleString()}</p></div>
                            <div><p class="text-[9px] text-slate-500 font-bold uppercase mb-1">Payable</p><p class="font-black text-rose-400 text-base">-$${pay.toLocaleString()}</p></div>
                        </div>
                    </div>
                    ${friends.length > 0 ? `
                    <div class="snap-center shrink-0 w-[85%] bg-white border border-slate-100 p-8 rounded-[3rem] shadow-xl flex flex-col justify-between">
                        <div>
                            <p class="text-[10px] text-slate-400 font-black uppercase mb-4 tracking-widest">Next Birthday</p>
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 rounded-full bg-slate-50 border-2 border-indigo-50 overflow-hidden shadow-sm">
                                    <img src="${friends[0].profiles?.avatar_url || `https://api.dicebear.com/9.x/avataaars/svg?seed=${friends[0].profiles?.username}`}" class="w-full h-full object-cover">
                                </div>
                                <div>
                                    <p class="font-black text-slate-900 text-lg leading-none">${friends[0].nickname || friends[0].profiles?.username}</p>
                                    <p class="text-[10px] font-bold text-slate-300 mt-2 tracking-widest">${friends[0].profiles?.birthday}</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-end justify-between">
                            <h2 class="text-5xl font-black text-indigo-600 leading-none tracking-tighter">${friends[0].days}<span class="text-sm text-slate-300 ml-1 font-black">DAYS</span></h2>
                            <button onclick="syncCalendar('${friends[0].nickname}', '${friends[0].profiles?.birthday}')" class="p-4 bg-indigo-50 text-indigo-600 rounded-[1.5rem] btn-press shadow-sm"><i data-lucide="calendar" class="w-6 h-6"></i></button>
                        </div>
                    </div>` : `
                    <div class="snap-center shrink-0 w-[85%] bg-indigo-600 text-white p-8 rounded-[3rem] shadow-xl flex flex-col justify-center items-center text-center">
                        <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mb-6"><i data-lucide="plus-circle" class="w-8 h-8"></i></div>
                        <p class="font-black text-sm mb-6 leading-relaxed">é‚€è«‹ä½ çš„æœ‹å‹åŠ å…¥ç¾¤çµ„<br>é–‹å§‹åˆ†äº«é¡˜æœ›èˆ‡è¨˜å¸³</p>
                        <button onclick="switchTab('settings')" class="w-full py-4 bg-white text-indigo-600 rounded-[1.5rem] text-[11px] font-black uppercase tracking-widest shadow-lg">å–å¾—é‚€è«‹ç¢¼</button>
                    </div>`}
                </div>
                <div class="space-y-5">
                    <h3 class="text-xs font-black text-slate-300 uppercase tracking-[0.2em] px-2">Group Dynamic</h3>
                    <div class="grid grid-cols-1 gap-4">
                        ${friends.map(m => `
                            <div class="bg-white p-5 rounded-[2rem] shadow-sm border border-slate-100 flex justify-between items-center transition-transform active:scale-[0.98]">
                                <div class="flex items-center gap-4">
                                    <div class="w-11 h-11 rounded-full bg-slate-50 overflow-hidden border border-slate-100"><img src="${m.profiles?.avatar_url || `https://api.dicebear.com/9.x/avataaars/svg?seed=${m.profiles?.username}`}" class="w-full h-full"></div>
                                    <p class="font-bold text-slate-800 text-base">${m.nickname || m.profiles?.username}</p>
                                </div>
                                <span class="font-black text-slate-200 text-sm tracking-tighter">${m.days}D</span>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        }

        // 6. é¡˜æœ›èˆ‡å¸³å‹™ (æ•´åˆé©šå–œèˆ‡è‰²å½©)
        async function renderGifts(container) {
            const { data: gifts } = await _supabase.from('gifts').select('*').order('created_at', { ascending: false });
            container.innerHTML = `<h2 class="text-3xl font-black mb-8 tracking-tight">Wishlist</h2><div class="space-y-5">${gifts?.map(g => {
                const isMine = g.creator_id === currentUser.id;
                const v = Math.floor(Math.random() * 5) + 1;
                return `
                <div class="bg-white p-6 rounded-[2.2rem] border border-slate-100 shadow-sm flex justify-between items-center ${g.priority === 'high' ? 'priority-high-border' : ''}">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <p class="font-black text-slate-800 text-base tracking-tight">${g.item_name}</p>
                            ${g.priority === 'high' ? '<span class="bg-rose-50 text-rose-500 px-2 py-0.5 rounded text-[8px] font-black uppercase">HOT</span>' : ''}
                        </div>
                        <p class="text-xs font-bold text-indigo-500 tracking-wide">$ ${g.amount.toLocaleString()}</p>
                    </div>
                    <div>
                        ${isMine ? `<div class="text-right text-slate-200"><p class="text-[9px] font-black uppercase tracking-widest">${g.is_reserved ? 'å·²è¢«èªé ˜ ğŸ¤«' : 'ç­‰å¾…é©šå–œ'}</p><p class="text-[9px] font-bold mt-0.5 flex items-center gap-1 justify-end"><i data-lucide="users" class="w-3 h-3"></i> ${v} äººæ­£é—œæ³¨</p></div>` : (g.is_reserved ? `<span class="badge text-emerald-600 bg-emerald-50 border border-emerald-100">å·²ç¢ºèªèªé ˜</span>` : `<button onclick="reserveGift('${g.id}', this)" class="btn-sm bg-slate-900 text-white font-black hover:bg-black">èªé ˜é¡˜æœ›</button>`)}
                    </div>
                </div>`;
            }).join('') || renderEmpty('æ¸…å–®æ˜¯ç©ºçš„', 'æ–°å¢ä¸€å€‹é¡˜æœ›å§ï¼')}</div>`;
        }

        async function renderLedgers(container) {
            const { data: ls } = await _supabase.from('ledgers').select('*, creditor:profiles!creditor_id(username), debtor:profiles!debtor_id(username)').order('created_at', { ascending: false });
            container.innerHTML = `<h2 class="text-3xl font-black mb-8 tracking-tight">Ledgers</h2><div class="space-y-4">${ls?.map(l => {
                const isMeCred = l.creditor_id === currentUser.id;
                let btn = '';
                if(l.status==='pending') btn = !isMeCred ? `<button onclick="updateLedger('${l.id}','confirmed',this)" class="btn-sm bg-emerald-500 text-white">ç¢ºèª</button>` : `<span class="badge text-amber-500 bg-amber-50">å¾…ç¢ºèª</span>`;
                else if(l.status==='confirmed') btn = !isMeCred ? `<button onclick="updateLedger('${l.id}','settling',this)" class="btn-sm bg-indigo-600 text-white">å»é‚„æ¬¾</button>` : `<span class="badge text-emerald-600 bg-emerald-50">å·²ç¢ºèª</span>`;
                else if(l.status==='settling') btn = isMeCred ? `<button onclick="updateLedger('${l.id}','settled',this)" class="btn-sm bg-slate-900 text-white">ç¢ºèªæ”¶æ¬¾</button>` : `<span class="badge text-indigo-500 bg-indigo-50 font-black">ç¢ºèªä¸­</span>`;
                else btn = `<span class="badge text-slate-200 bg-slate-50 line-through">å·²çµæ¸…</span>`;

                return `<div class="bg-white p-6 rounded-[2rem] border border-slate-100 flex justify-between items-center shadow-sm">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center ${isMeCred ? 'bg-emerald-50 text-emerald-500' : 'bg-rose-50 text-rose-500'}">
                            <i data-lucide="${isMeCred ? 'arrow-down-left' : 'arrow-up-right'}" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <p class="text-[9px] font-black text-slate-300 uppercase tracking-widest mb-1">${l.description || 'å¸³å‹™'}</p>
                            <p class="font-bold text-sm"><span class="text-slate-800">${isMeCred ? l.debtor?.username : l.creditor?.username}</span><span class="ml-2 font-black ${isMeCred?'text-emerald-600':'text-rose-500'}">$${l.amount.toLocaleString()}</span></p>
                        </div>
                    </div>
                    <div>${btn}</div>
                </div>`;
            }).join('') || renderEmpty('ç›®å‰ç„¡å¸³å‹™', 'å¥½æœ‹å‹ï¼Œæ˜ç®—å¸³ã€‚')}</div>`;
        }

        // 7. è¨­å®šé é¢
        async function renderSettingsPage(container) {
            const { data: p } = await _supabase.from('profiles').select('*').eq('id', currentUser.id).single();
            const { data: gs } = await _supabase.from('groups').select('*');
            const avatar = p?.avatar_url || `https://api.dicebear.com/9.x/avataaars/svg?seed=${p?.username || currentUser.email}`;

            container.innerHTML = `
                <div class="flex flex-col items-center mb-12 text-center">
                    <div class="relative w-32 h-32 mb-8 group cursor-pointer" onclick="openAvatarModal()">
                        <div class="w-full h-full rounded-full bg-slate-100 p-1.5 shadow-2xl border-4 border-white overflow-hidden">
                            <img src="${avatar}" class="w-full h-full rounded-full object-cover">
                        </div>
                        <div class="absolute bottom-1 right-1 bg-slate-900 text-white p-2.5 rounded-full border-4 border-slate-50"><i data-lucide="camera" class="w-4 h-4"></i></div>
                    </div>
                    <h2 class="text-3xl font-black text-slate-900 tracking-tighter">${p?.username || 'User'}</h2>
                    <p class="text-xs font-bold text-slate-400 mt-2 mb-8 tracking-widest uppercase">${currentUser.email}</p>
                    <button onclick="handleEditProfile('${p?.username}','${p?.birthday}','${p?.payment_info}')" class="px-10 py-4 bg-slate-900 text-white text-xs font-black rounded-full shadow-xl btn-press">ç·¨è¼¯å€‹äººæª”æ¡ˆèˆ‡æ”¯ä»˜</button>
                </div>

                <div class="space-y-6">
                    <div class="bg-indigo-600 rounded-[3rem] p-8 text-white shadow-2xl shadow-indigo-100">
                        <p class="text-[10px] font-black text-indigo-200 uppercase tracking-[0.2em] mb-4">è½‰å¸³è³‡è¨Š (ä»˜æ¬¾äººå¯è¦‹)</p>
                        <p class="text-sm font-bold bg-white/10 p-5 rounded-[1.5rem] border border-white/20 break-all leading-relaxed">${p?.payment_info || 'å°šæœªè¨­å®šï¼Œé»æ“Šä¸Šæ–¹ç·¨è¼¯æŒ‰éˆ•'}</p>
                    </div>

                    <div class="bg-white rounded-[3rem] p-6 border border-slate-100 shadow-sm">
                        <h3 class="px-4 text-[10px] font-black text-slate-300 uppercase tracking-widest my-4">Group Management</h3>
                        <div class="space-y-2">
                            ${gs?.map(g => `<div class="flex justify-between items-center p-4 rounded-3xl hover:bg-slate-50 transition-colors"><span class="font-bold text-sm text-slate-700">${g.name}</span><button onclick="shareInvite('${g.invite_code}')" class="text-[10px] font-black text-indigo-600 bg-indigo-50 px-5 py-2.5 rounded-full">é‚€è«‹</button></div>`).join('') || '<p class="p-8 text-center text-xs text-slate-300">ç›®å‰ç„¡ç¾¤çµ„</p>'}
                        </div>
                        <div class="grid grid-cols-2 gap-3 mt-6">
                            <button onclick="handleCreateGroup()" class="py-5 bg-slate-50 rounded-[1.5rem] text-[11px] font-black text-slate-600 btn-press uppercase">å»ºç«‹ç¾¤çµ„</button>
                            <button onclick="handleJoinGroup()" class="py-5 bg-slate-50 rounded-[1.5rem] text-[11px] font-black text-slate-600 btn-press uppercase">åŠ å…¥ç¾¤çµ„</button>
                        </div>
                    </div>

                    <button onclick="handleLogout()" class="w-full py-5 text-rose-500 font-black text-xs bg-white rounded-[2rem] shadow-sm border border-slate-100 btn-press">ç™»å‡ºç•¶å‰å¸³è™Ÿ</button>
                </div>`;
        }

        // 8. å–ä»£ Prompt çš„äº’å‹•é‚è¼¯
        function handleEditProfile(n, b, p) {
            showUniversalModal("ç·¨è¼¯å€‹äººæª”æ¡ˆ", [
                { id: 'name', label: 'é¡¯ç¤ºæš±ç¨±', placeholder: 'ä½ çš„åå­—', value: n },
                { id: 'birthday', label: 'ç”Ÿæ—¥ (YYYY-MM-DD)', placeholder: '1995-12-30', value: b },
                { id: 'payment', label: 'è½‰å¸³è³‡è¨Š (éŠ€è¡Œ/å¸³è™Ÿ/LINE Pay)', placeholder: '822 åœ‹æ³° 12345...', value: p }
            ], async (data) => {
                const { error } = await _supabase.from('profiles').update({ username: data.name, birthday: data.birthday, payment_info: data.payment }).eq('id', currentUser.id);
                if (!error) { showToast("è³‡æ–™æ›´æ–°æˆåŠŸ", 'success'); renderContent(); updateHeaderAvatar(); }
            });
        }

        function handleCreateGroup() {
            showUniversalModal("å»ºç«‹æ–°ç¾¤çµ„", [
                { id: 'name', label: 'ç¾¤çµ„åç¨±', placeholder: 'ä¾‹å¦‚ï¼šä¸‰äº”å¥½å‹ã€å®¶åº­æ—…éŠ' }
            ], async (data) => {
                const { data: g, error } = await _supabase.from('groups').insert([{ name: data.name, creator_id: currentUser.id }]).select().single();
                if (!error) {
                    await _supabase.from('group_members').insert([{ group_id: g.id, user_id: currentUser.id, role: 'admin' }]);
                    showToast("ç¾¤çµ„å»ºç«‹æˆåŠŸ", 'success'); renderContent(); loadGroupsToSelect();
                }
            });
        }

        function handleJoinGroup() {
            showUniversalModal("åŠ å…¥ç¾æœ‰ç¾¤çµ„", [
                { id: 'code', label: '6 ç¢¼é‚€è«‹ç¢¼', placeholder: 'ä¾‹å¦‚ï¼šxc821s' }
            ], async (data) => {
                // é€™è£¡ä½¿ç”¨ RPC å‘¼å«é ç•™é‚è¼¯
                const { error } = await _supabase.rpc('join_group_by_invite', { code: data.code });
                if (!error) { showToast("å·²æˆåŠŸåŠ å…¥ç¾¤çµ„", 'success'); renderContent(); loadGroupsToSelect(); }
                else showToast(error.message, 'error');
            });
        }

        function openAvatarModal() {
            showUniversalModal("æ›´æ–°å¤§é ­è²¼", [
                { id: 'url', label: 'åœ–ç‰‡é€£çµ (JPG/PNG)', placeholder: 'è²¼ä¸Šåœ–ç‰‡ç¶²å€' }
            ], async (data) => {
                const { error } = await _supabase.from('profiles').update({ avatar_url: data.url.trim() || null }).eq('id', currentUser.id);
                if (!error) { renderContent(); updateHeaderAvatar(); showToast("é ­åƒå·²æ›´æ–°", 'success'); }
            });
        }

        // 9. æ ¸å¿ƒäº¤æ˜“é‚è¼¯
        async function updateLedger(id, status, btn) {
            triggerHaptic();
            if (status === 'settling') {
                const { data: l } = await _supabase.from('ledgers').select('creditor_id, profiles!creditor_id(username, payment_info)').eq('id', id).single();
                const payInfo = l.profiles?.payment_info || "å°æ–¹æœªè¨­å®šè½‰å¸³è³‡è¨Š";
                if(l.profiles?.payment_info) await navigator.clipboard.writeText(payInfo);
                
                const confirmed = confirm(`å·²è‡ªå‹•è¤‡è£½å¸³è™Ÿï¼\nè«‹è½‰å¸³è‡³ ${l.profiles.username} çš„å¸³æˆ¶ï¼š\n\nã€ ${payInfo} ã€‘\n\nç¢ºå®šå·²å®Œæˆè½‰å¸³ï¼Ÿ`);
                if (!confirmed) return;
            }

            setLoading(btn, true);
            const { error } = await _supabase.from('ledgers').update({ status }).eq('id', id);
            if (!error) { 
                if(status==='settled') triggerConfetti();
                showToast("æ›´æ–°ç‹€æ…‹æˆåŠŸ", 'success'); renderContent(); 
            } else { setLoading(btn, false); showToast(error.message, 'error'); }
        }

        async function reserveGift(id, btn) {
            triggerHaptic();
            if (!confirm("èªé ˜å¾Œæœ‹å‹å°‡çœ‹åˆ°è©²é …ç›®å·²è¢«èªé ˜ï¼Œç¢ºå®šèªé ˜ï¼Ÿ")) return;
            setLoading(btn, true);
            const { error } = await _supabase.from('gifts').update({ is_reserved: true, reserved_by: currentUser.id }).eq('id', id);
            if (!error) { triggerConfetti(); showToast("èªé ˜æˆåŠŸï¼", 'success'); renderContent(); }
            else { setLoading(btn, false); showToast("èªé ˜å¤±æ•—", 'error'); }
        }

        async function handleSubmit(btn) {
            triggerHaptic();
            const name = document.getElementById('add-name').value;
            const amount = document.getElementById('add-amount').value;
            const gid = document.getElementById('add-group-id').value;
            if (!name || !gid) return showToast("åç¨±èˆ‡ç¾¤çµ„ç‚ºå¿…å¡«", 'error');

            setLoading(btn, true);
            let err;
            if (currentAddType === 'wishlist') {
                const p = document.getElementById('add-priority').value;
                const res = await _supabase.from('gifts').insert([{ item_name: name, amount: parseInt(amount)||0, group_id: gid, priority: p, creator_id: currentUser.id }]);
                err = res.error;
            } else {
                const target = document.getElementById('add-target-member').value;
                if (!target) { setLoading(btn, false); return showToast("è«‹é¸æ“‡å€Ÿè²¸å°è±¡", 'error'); }
                let cred = debtDirection === 'owe_me' ? currentUser.id : target;
                let debt = debtDirection === 'owe_me' ? target : currentUser.id;
                const res = await _supabase.from('ledgers').insert([{ description: name, amount: parseInt(amount)||0, group_id: gid, creditor_id: cred, debtor_id: debt }]);
                err = res.error;
            }

            if (!err) { showToast("ç´€éŒ„æˆåŠŸ", 'success'); closeModal(); renderContent(); }
            else { setLoading(btn, false); showToast(err.message, 'error'); }
        }

        // 10. è¼”åŠ©å‡½å¼åº«
        function setLoading(btn, load) {
            btn.disabled = load;
            if (load) { btn.dataset.o = btn.innerHTML; btn.innerHTML = '<div class="spinner mx-auto"></div>'; }
            else { btn.innerHTML = btn.dataset.o || btn.innerHTML; }
        }

        function showToast(msg, type='info') {
            const t = document.getElementById('toast');
            const icon = type === 'success' ? 'check-circle' : (type === 'error' ? 'x-circle' : 'info');
            const color = type === 'success' ? 'text-emerald-400' : (type === 'error' ? 'text-rose-400' : 'text-blue-400');
            t.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 ${color}"></i><span>${msg}</span>`;
            t.classList.add('show');
            lucide.createIcons();
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function triggerConfetti() { confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, colors: ['#4f46e5', '#10b981', '#fb7185'] }); }
        function triggerHaptic() { if (navigator.vibrate) navigator.vibrate(15); }
        function calculateDays(d) { if(!d)return 999; const t=new Date(),b=new Date(d); b.setFullYear(t.getFullYear()); if(b<t)b.setFullYear(t.getFullYear()+1); return Math.ceil((b - t) / 864e5); }
        function getSkeletonLoader() { return `<div class="space-y-6 animate-in fade-in"><div class="h-44 bg-slate-100 rounded-[3rem]"></div><div class="h-24 bg-slate-100 rounded-[2rem]"></div><div class="h-24 bg-slate-100 rounded-[2rem]"></div></div>`; }
        function renderEmpty(t, d) { return `<div class="flex flex-col items-center justify-center h-80 opacity-40 text-center px-12"><i data-lucide="ghost" class="w-14 h-14 mb-5"></i><h3 class="text-xl font-black">${t}</h3><p class="text-xs font-bold mt-2">${d}</p></div>`; }
        function openAddModal() { document.getElementById('add-modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('add-modal').classList.add('hidden'); }
        function setAddType(t) { currentAddType=t; const isW=t==='wishlist'; document.getElementById('type-wish').className=isW?'flex-1 py-4 rounded-[1.2rem] text-xs font-black bg-white shadow-sm text-indigo-600 transition-all':'flex-1 py-4 rounded-[1.2rem] text-xs font-black text-slate-400 transition-all'; document.getElementById('type-debt').className=!isW?'flex-1 py-4 rounded-[1.2rem] text-xs font-black bg-white shadow-sm text-indigo-600 transition-all':'flex-1 py-4 rounded-[1.2rem] text-xs font-black text-slate-400 transition-all'; document.getElementById('debt-options').classList.toggle('hidden', isW); document.getElementById('add-priority').parentElement.classList.toggle('hidden', !isW); if(!isW) loadGroupMembersForDebt(document.getElementById('add-group-id').value); }
        function setDebtDirection(d) { debtDirection=d; document.getElementById('dir-owe-me').className = d==='owe_me'?'flex-1 py-4 border-2 border-indigo-600 bg-indigo-50 text-indigo-700 rounded-2xl text-xs font-black transition-all':'flex-1 py-4 border-2 border-slate-100 text-slate-400 rounded-2xl text-xs font-black transition-all'; document.getElementById('dir-i-owe').className = d!=='owe_me'?'flex-1 py-4 border-2 border-rose-500 bg-rose-50 text-rose-600 rounded-2xl text-xs font-black transition-all':'flex-1 py-4 border-2 border-slate-100 text-slate-400 rounded-2xl text-xs font-black transition-all'; }
        async function updateHeaderAvatar() { const{data:p}=await _supabase.from('profiles').select('avatar_url,username').eq('id',currentUser.id).single(); const url=p?.avatar_url||`https://api.dicebear.com/9.x/avataaars/svg?seed=${p?.username||currentUser.email}`; document.getElementById('header-avatar').innerHTML=`<img src="${url}" class="w-full h-full object-cover">`; }
        async function handleLogout() { await _supabase.auth.signOut(); window.location.reload(); }
        async function loadGroupsToSelect() { const{data}=await _supabase.from('groups').select('*'); const s=document.getElementById('add-group-id'); if(s){ s.innerHTML='<option value="">é¸æ“‡åƒèˆ‡ç¾¤çµ„</option>'; data?.forEach(g=>s.innerHTML+=`<option value="${g.id}">${g.name}</option>`); } }
        async function loadGroupMembersForDebt(gid) { const{data:ms}=await _supabase.from('group_members').select('user_id,profiles(username)').eq('group_id',gid); const s=document.getElementById('add-target-member'); s.innerHTML=''; ms?.filter(m=>m.user_id!==currentUser.id).forEach(m=>s.innerHTML+=`<option value="${m.user_id}">${m.profiles?.username||'User'}</option>`); }
        function shareInvite(c) { const url=`${window.location.origin}${window.location.pathname}?invite=${c}`; if(navigator.share) navigator.share({title:'åŠ å…¥æˆ‘çš„ GiftFlow', url}); else { navigator.clipboard.writeText(url); showToast("é€£çµå·²è¤‡è£½", 'success'); } }
        function syncCalendar(n,b) { if(!b) return showToast("æ—¥æœŸæœªè¨­å®š", 'error'); const t=new Date(),[y,m,d]=b.split('-'); let ny=t.getFullYear(); if(new Date(ny,m-1,d)<t) ny++; const ds=`${ny}${m}${d}`; window.open(`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${n}ç”Ÿæ—¥&dates=${ds}/${ds}`,'_blank'); }
    </script>
</body>
</html>
