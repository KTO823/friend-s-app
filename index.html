<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>GIFTFLOW PRO - Ultimate Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Glassmorphism é¢¨æ ¼ */
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(241, 245, 249, 0.5); }
        .safe-bottom { padding-bottom: calc(env(safe-area-inset-bottom) + 20px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Toast ç³»çµ± */
        .toast { position: fixed; top: 30px; left: 50%; transform: translateX(-50%) translateY(-120px); background: rgba(15, 23, 42, 0.95); color: white; padding: 12px 28px; border-radius: 99px; font-size: 13px; font-weight: bold; opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none; z-index: 9999; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 8px; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        /* æŒ‰éˆ•åé¥‹ */
        .btn-press:active { transform: scale(0.96); transition: transform 0.1s; }
        
        /* è¼‰å…¥å‹•ç•« */
        .spinner { width: 1.2em; height: 1.2em; border: 2.5px solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spin .75s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* é«˜å„ªå…ˆç´šé¡˜æœ›ï¼šä½¿ç”¨éœæ…‹å…‰æšˆå–ä»£é–ƒçˆ */
        .priority-high { border: 2px solid #fb7185; box-shadow: 0 0 15px rgba(251, 113, 133, 0.1); }
        
        /* å¡ç‰‡æ»‘å‹• */
        .snap-x-mandatory { scroll-snap-type: x mandatory; }
        .snap-center { scroll-snap-align: center; }

        /* è‡ªå®šç¾©å…ƒä»¶æ¨£å¼ */
        .badge { @apply px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-wider; }
        .btn-sm { @apply px-4 py-2 rounded-full text-[11px] font-bold shadow-sm transition-all active:scale-95; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 overflow-x-hidden select-none">

    <div id="toast" class="toast"></div>

    <div id="login-screen" class="flex flex-col items-center justify-center min-h-screen p-6 relative z-50 bg-slate-50 transition-opacity duration-500">
        <div class="w-full max-w-md bg-white rounded-[3rem] shadow-2xl p-10 text-center border border-slate-100">
            <div class="w-20 h-20 bg-indigo-600 rounded-[2rem] mx-auto mb-8 flex items-center justify-center text-white shadow-xl shadow-indigo-100">
                <i data-lucide="gift" class="w-10 h-10"></i>
            </div>
            <h1 class="text-3xl font-black mb-2 tracking-tight text-slate-900">GIFTFLOW</h1>
            <p class="text-xs font-bold text-slate-400 mb-10 uppercase tracking-[0.2em]">Social Wishlist & Ledger</p>
            
            <form id="auth-form" class="space-y-4 text-left">
                <div class="space-y-3">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-4">Email Address</label>
                    <input type="email" id="email" placeholder="name@example.com" required class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:bg-white focus:border-indigo-600 transition-all font-bold text-sm">
                </div>
                <div class="space-y-3">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-4">Password</label>
                    <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:bg-white focus:border-indigo-600 transition-all font-bold text-sm">
                </div>
                <div class="flex gap-3 mt-8">
                    <button type="button" onclick="handleAuth('login', this)" class="flex-1 py-4 bg-slate-900 text-white font-black rounded-2xl shadow-xl btn-press">ç™»å…¥</button>
                    <button type="button" onclick="handleAuth('signup', this)" class="flex-1 py-4 bg-white border border-slate-200 text-slate-900 font-black rounded-2xl btn-press">è¨»å†Š</button>
                </div>
            </form>
        </div>
    </div>

    <div id="main-app" class="hidden max-w-md mx-auto min-h-screen flex flex-col">
        <header class="px-6 py-5 sticky top-0 z-40 flex justify-between items-center glass">
            <div class="flex items-center gap-2 cursor-pointer active:opacity-60 transition-opacity" onclick="switchTab('dashboard')">
                <div class="w-2.5 h-2.5 bg-indigo-600 rounded-full"></div>
                <h1 class="text-xl font-black italic text-indigo-600 tracking-tighter uppercase">GiftFlow</h1>
            </div>
            <button onclick="switchTab('settings')" class="relative btn-press">
                <div id="header-avatar" class="w-10 h-10 rounded-full bg-slate-100 overflow-hidden border-2 border-white shadow-sm ring-2 ring-slate-50"></div>
            </button>
        </header>

        <main id="content" class="p-6 flex-1 pb-40 overflow-y-auto hide-scrollbar space-y-8"></main>

        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto glass border-t border-slate-100 px-10 pt-4 pb-10 flex justify-between items-center z-40 safe-bottom">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-btn opacity-40 transition-all"><i data-lucide="layout-grid" class="w-6 h-6"></i></button>
            <button onclick="switchTab('gifts')" id="nav-gifts" class="nav-btn opacity-40 transition-all"><i data-lucide="gift" class="w-6 h-6"></i></button>
            <div class="relative -top-8">
                <button onclick="openAddModal()" class="bg-indigo-600 text-white p-5 rounded-full shadow-2xl shadow-indigo-200 ring-8 ring-white btn-press"><i data-lucide="plus" class="w-7 h-7"></i></button>
            </div>
            <button onclick="switchTab('ledgers')" id="nav-ledgers" class="nav-btn opacity-40 transition-all"><i data-lucide="wallet" class="w-6 h-6"></i></button>
            <button onclick="switchTab('settings')" id="nav-settings" class="nav-btn opacity-40 transition-all"><i data-lucide="user-circle" class="w-6 h-6"></i></button>
        </nav>
    </div>

    <div id="add-modal" class="hidden fixed inset-0 z-50 bg-slate-900/60 backdrop-blur-md flex items-end justify-center p-0 sm:p-4 transition-opacity">
        <div class="bg-white w-full max-w-md rounded-t-[3rem] sm:rounded-[3rem] p-8 shadow-2xl animate-in slide-in-from-bottom duration-300">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-black text-slate-800 tracking-tight">Create New</h2>
                <button onclick="closeModal()" class="p-2 bg-slate-50 rounded-full hover:bg-slate-100"><i data-lucide="x" class="w-6 h-6 text-slate-400"></i></button>
            </div>
            
            <div class="flex p-1.5 bg-slate-100 rounded-2xl mb-8">
                <button onclick="setAddType('wishlist')" id="type-wish" class="flex-1 py-3.5 rounded-xl text-xs font-black bg-white shadow-sm text-indigo-600 transition-all">ğŸ é¡˜æœ›</button>
                <button onclick="setAddType('debt')" id="type-debt" class="flex-1 py-3.5 rounded-xl text-xs font-black text-slate-400 transition-all">ğŸ’¸ è¨˜å¸³</button>
            </div>

            <form id="add-form" class="space-y-5">
                <input type="text" id="add-name" placeholder="é …ç›®åç¨± (ä¾‹å¦‚: æ™šé¤åˆ†æ”¤)" required class="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold text-sm focus:bg-white focus:ring-2 ring-indigo-100 transition-all">
                
                <div class="flex gap-4">
                    <input type="number" id="add-amount" placeholder="é‡‘é¡" class="flex-1 p-4 bg-slate-50 rounded-2xl outline-none font-bold text-sm focus:bg-white focus:ring-2 ring-indigo-100 transition-all">
                    <select id="add-priority" class="flex-1 p-4 bg-slate-50 rounded-2xl outline-none font-bold text-xs text-slate-600">
                        <option value="normal">æ¬Šé‡: ä¸€èˆ¬</option>
                        <option value="high">ğŸ”¥ æ¥µåº¦æƒ³è¦</option>
                        <option value="low">â˜• éš¨ç·£</option>
                    </select>
                </div>

                <select id="add-group-id" class="w-full p-4 bg-indigo-50/50 rounded-2xl outline-none font-bold text-sm text-indigo-600" onchange="loadGroupMembersForDebt(this.value)"></select>

                <div id="debt-options" class="hidden space-y-4 pt-2">
                    <div class="flex gap-3">
                        <button type="button" onclick="setDebtDirection('owe_me')" id="dir-owe-me" class="flex-1 py-3 border-2 border-indigo-600 bg-indigo-50 text-indigo-700 rounded-xl text-xs font-bold transition-all">åˆ¥äººæ¬ æˆ‘</button>
                        <button type="button" onclick="setDebtDirection('i_owe')" id="dir-i-owe" class="flex-1 py-3 border-2 border-slate-100 text-slate-400 rounded-xl text-xs font-bold transition-all">æˆ‘æ¬ åˆ¥äºº</button>
                    </div>
                    <select id="add-target-member" class="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold text-sm text-slate-700"></select>
                </div>

                <button type="button" onclick="handleSubmit(this)" class="w-full py-5 bg-slate-900 text-white font-black rounded-2xl shadow-xl mt-4 btn-press">ç™¼ä½ˆç´€éŒ„</button>
            </form>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://kzzxyyykpiquanxtfkwr.supabase.co'; 
        const supabaseKey = 'sb_publishable_K0ThQ9_ZqPPYk0sxxWgLhg_qwzuMNeG'; 
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let activeTab = 'dashboard';
        let currentAddType = 'wishlist';
        let debtDirection = 'owe_me';

        // 1. åˆå§‹åŒ–èˆ‡èº«ä»½æª¢æŸ¥
        window.onload = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const inviteCode = urlParams.get('invite');
            if (inviteCode) localStorage.setItem('pending_invite', inviteCode);

            const { data: { session } } = await _supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                showApp();
                const pending = localStorage.getItem('pending_invite');
                if (pending) { joinGroupLogic(pending); localStorage.removeItem('pending_invite'); }
            }
            lucide.createIcons();
            setupRealtime();
        };

        function setupRealtime() {
            _supabase.channel('public-db-changes').on('postgres_changes', { event: '*', schema: 'public' }, () => renderContent()).subscribe();
        }

        // 2. èº«ä»½é©—è­‰é‚è¼¯
        async function handleAuth(type, btn) {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            if (!email || !password) return showToast("è«‹å®Œæ•´å¡«å¯« Email èˆ‡å¯†ç¢¼", 'error');

            setLoading(btn, true);
            const res = type === 'login' 
                ? await _supabase.auth.signInWithPassword({ email, password }) 
                : await _supabase.auth.signUp({ email, password });
            setLoading(btn, false);

            if (res.error) showToast(res.error.message, 'error');
            else if (type === 'signup') showToast("è¨»å†ŠæˆåŠŸï¼Œè«‹å‰å¾€ç™»å…¥", 'success');
            else { currentUser = res.data.user; showApp(); }
        }

        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            updateHeaderAvatar();
            switchTab('dashboard');
            loadGroupsToSelect();
        }

        // 3. é é¢åˆ‡æ›èˆ‡å…§å®¹æ¸²æŸ“
        function switchTab(t) {
            activeTab = t;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.add('opacity-40'));
            document.getElementById('nav-' + t).classList.remove('opacity-40');
            renderContent();
        }

        async function renderContent() {
            const container = document.getElementById('content');
            container.innerHTML = getSkeletonLoader();

            if (activeTab === 'dashboard') await renderDashboard(container);
            else if (activeTab === 'gifts') await renderGifts(container);
            else if (activeTab === 'ledgers') await renderLedgers(container);
            else if (activeTab === 'settings') await renderSettingsPage(container);
            
            lucide.createIcons();
        }

        // 4. å„€è¡¨æ¿ï¼šæ™ºæ…§å¡ç‰‡é‚è¼¯
        async function renderDashboard(container) {
            const [membersRes, ledgersRes] = await Promise.all([
                _supabase.from('group_members').select('*, profiles(*)'),
                _supabase.from('ledgers').select('*')
            ]);
            
            if (!membersRes.data || membersRes.data.length === 0) return renderEmpty('æ­¡è¿ä½¿ç”¨ GiftFlow', 'å»è¨­å®šé é¢å»ºç«‹ç¾¤çµ„é–‹å§‹ç¤¾äº¤å§ï¼');

            let receivable = 0, payable = 0;
            ledgersRes.data?.forEach(l => {
                if (l.status !== 'settled') {
                    if (l.creditor_id === currentUser.id) receivable += l.amount;
                    if (l.debtor_id === currentUser.id) payable += l.amount;
                }
            });

            const friends = membersRes.data
                .filter(m => m.user_id !== currentUser.id)
                .map(m => ({ ...m, days: calculateDays(m.profiles?.birthday) }))
                .sort((a, b) => a.days - b.days);

            container.innerHTML = `
                <div class="flex overflow-x-auto snap-x snap-mandatory gap-4 pb-4 -mx-6 px-6 hide-scrollbar">
                    <div class="snap-center shrink-0 w-[85%] bg-slate-900 text-white p-7 rounded-[2.5rem] shadow-xl relative overflow-hidden">
                        <div class="absolute -top-4 -right-4 w-24 h-24 bg-white/5 rounded-full"></div>
                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-1">Financial Overview</p>
                        <h2 class="text-3xl font-black mb-6 tracking-tighter ${receivable-payable >= 0 ? 'text-emerald-400' : 'text-rose-400'}">
                            ${receivable-payable >= 0 ? '+' : ''}$ ${(receivable-payable).toLocaleString()}
                        </h2>
                        <div class="flex gap-6 border-t border-white/10 pt-5">
                            <div><p class="text-[9px] text-slate-500 font-bold uppercase mb-1 tracking-wider">æ‡‰æ”¶</p><p class="font-black text-emerald-400 text-sm">+$${receivable.toLocaleString()}</p></div>
                            <div><p class="text-[9px] text-slate-500 font-bold uppercase mb-1 tracking-wider">æ‡‰ä»˜</p><p class="font-black text-rose-400 text-sm">-$${payable.toLocaleString()}</p></div>
                        </div>
                    </div>

                    ${friends.length > 0 ? `
                    <div class="snap-center shrink-0 w-[85%] bg-white border border-slate-100 p-7 rounded-[2.5rem] shadow-xl shadow-slate-200/50 flex flex-col justify-between">
                        <div>
                            <p class="text-[10px] text-slate-400 font-black uppercase tracking-[0.2em] mb-4">Upcoming Birthday</p>
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-full bg-slate-100 overflow-hidden border-2 border-indigo-50 shadow-sm">
                                    <img src="${friends[0].profiles?.avatar_url || `https://api.dicebear.com/9.x/avataaars/svg?seed=${friends[0].profiles?.username}`}" class="w-full h-full object-cover">
                                </div>
                                <div>
                                    <p class="font-black text-slate-900 text-base">${friends[0].nickname || friends[0].profiles?.username}</p>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">${friends[0].profiles?.birthday || 'æœªè¨­å®šæ—¥æœŸ'}</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-end justify-between mt-4">
                            <h2 class="text-4xl font-black text-indigo-600 leading-none">${friends[0].days}<span class="text-xs text-slate-300 ml-1 font-black">DAYS</span></h2>
                            <button onclick="syncCalendar('${friends[0].nickname}', '${friends[0].profiles?.birthday}')" class="p-3 bg-indigo-50 text-indigo-600 rounded-2xl active:scale-90 transition-transform"><i data-lucide="calendar-plus" class="w-5 h-5"></i></button>
                        </div>
                    </div>` : `
                    <div class="snap-center shrink-0 w-[85%] bg-indigo-600 text-white p-7 rounded-[2.5rem] shadow-xl flex flex-col justify-center items-center text-center">
                        <div class="w-14 h-14 bg-white/20 rounded-full flex items-center justify-center mb-4"><i data-lucide="users" class="w-6 h-6 text-white"></i></div>
                        <p class="font-black text-sm mb-4">é‚€è«‹æœ‹å‹åŠ å…¥ç¾¤çµ„</p>
                        <button onclick="switchTab('settings')" class="w-full py-3 bg-white text-indigo-600 rounded-2xl text-[11px] font-black uppercase tracking-widest shadow-lg shadow-indigo-900/20">æŸ¥çœ‹é‚€è«‹é€£çµ</button>
                    </div>`}
                </div>

                <div class="space-y-4">
                    <div class="flex justify-between items-center px-1">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-[0.15em]">Group Members</h3>
                        <span class="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full">${friends.length} TOTAL</span>
                    </div>
                    <div class="grid grid-cols-1 gap-3">
                        ${friends.map(m => `
                            <div class="bg-white p-4 rounded-[1.8rem] shadow-sm border border-slate-100 flex justify-between items-center active:scale-[0.98] transition-transform">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-slate-50 overflow-hidden"><img src="${m.profiles?.avatar_url || `https://api.dicebear.com/9.x/avataaars/svg?seed=${m.profiles?.username}`}" class="w-full h-full"></div>
                                    <p class="font-bold text-sm text-slate-800">${m.nickname || m.profiles?.username}</p>
                                </div>
                                <span class="font-black text-slate-200 text-sm tracking-tighter">${m.days} DAYS</span>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        }

        // 5. é¡˜æœ›æ¸…å–®ï¼šé©šå–œé˜²è­·é‚è¼¯
        async function renderGifts(container) {
            const { data: gifts } = await _supabase.from('gifts').select('*').order('created_at', { ascending: false });
            if (!gifts || gifts.length === 0) return renderEmpty('é¡˜æœ›æ¸…å–®ç›®å‰æ˜¯ç©ºçš„', 'æ–°å¢ä¸€å€‹é¡˜æœ›ï¼Œè®“å¤§å®¶çµ¦ä½ é©šå–œï¼');

            container.innerHTML = `
                <h2 class="text-2xl font-black mb-6 tracking-tight text-slate-900">Wishlist</h2>
                <div class="space-y-4">
                    ${gifts.map(g => {
                        const isMine = g.creator_id === currentUser.id;
                        const views = Math.floor(Math.random() * 8) + 2; // ç¤¾äº¤æ¨¡æ“¬æ•¸æ“š
                        return `
                        <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm flex justify-between items-center ${g.priority === 'high' ? 'priority-high' : ''}">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <p class="font-black text-slate-800 text-sm uppercase">${g.item_name}</p>
                                    ${g.priority === 'high' ? '<span class="px-2 py-0.5 bg-rose-50 text-rose-500 rounded-md text-[8px] font-black">HIGH</span>' : ''}
                                </div>
                                <p class="text-xs font-bold text-indigo-600 tracking-tight">$ ${g.amount.toLocaleString()}</p>
                            </div>
                            <div>
                                ${isMine ? 
                                    `<div class="flex flex-col items-end gap-1">
                                        <span class="text-[9px] font-black text-slate-300 uppercase tracking-widest">${g.is_reserved ? 'å·²è¢«èªé ˜ ğŸ¤«' : 'ç­‰å¾…é©šå–œ'}</span>
                                        <div class="flex items-center gap-1 text-slate-200"><i data-lucide="eye" class="w-3 h-3"></i><span class="text-[9px] font-bold">${views} å¥½å‹é—œæ³¨</span></div>
                                    </div>` : 
                                    (g.is_reserved ? 
                                        `<span class="badge text-emerald-600 bg-emerald-50 border border-emerald-100">å·²ç¢ºèªèªé ˜</span>` : 
                                        `<button onclick="reserveGift('${g.id}', this)" class="btn-sm bg-slate-900 text-white font-black hover:bg-black">èªé ˜é¡˜æœ›</button>`
                                    )
                                }
                            </div>
                        </div>`;
                    }).join('')}
                </div>`;
        }

        // 6. å¸³å‹™æ¸…å–®ï¼šè‰²å½©å¼·åŒ–èˆ‡æ”¯ä»˜è³‡è¨Š
        async function renderLedgers(container) {
            const { data: ledgers } = await _supabase.from('ledgers').select('*, creditor:profiles!creditor_id(username), debtor:profiles!debtor_id(username)').order('created_at', { ascending: false });
            if (!ledgers || ledgers.length === 0) return renderEmpty('ä¹¾ä¹¾æ·¨æ·¨', 'æ²’æœ‰ä»»ä½•æœªçµæ¸…çš„å¸³å‹™ã€‚');

            container.innerHTML = `
                <h2 class="text-2xl font-black mb-6 tracking-tight text-slate-900">Ledgers</h2>
                <div class="space-y-3">
                    ${ledgers.map(l => {
                        const isMeCreditor = l.creditor_id === currentUser.id;
                        const otherName = isMeCreditor ? (l.debtor?.username || 'å°æ–¹') : (l.creditor?.username || 'å°æ–¹');
                        let actionBtn = '';
                        
                        if (l.status === 'pending') {
                            actionBtn = !isMeCreditor ? `<button onclick="updateLedger('${l.id}', 'confirmed', this)" class="btn-sm bg-emerald-500 text-white">ç¢ºèª</button>` : `<span class="badge text-amber-500 bg-amber-50">å¾…ç¢ºèª</span>`;
                        } else if (l.status === 'confirmed') {
                            actionBtn = !isMeCreditor ? `<button onclick="updateLedger('${l.id}', 'settling', this)" class="btn-sm bg-indigo-600 text-white">å»é‚„æ¬¾</button>` : `<span class="badge text-emerald-600 bg-emerald-50">å·²ç¢ºèª</span>`;
                        } else if (l.status === 'settling') {
                            actionBtn = isMeCreditor ? `<button onclick="updateLedger('${l.id}', 'settled', this)" class="btn-sm bg-slate-900 text-white">ç¢ºèªæ”¶æ¬¾</button>` : `<span class="badge text-indigo-500 bg-indigo-50">ç¢ºèªä¸­</span>`;
                        } else {
                            actionBtn = `<span class="badge text-slate-200 bg-slate-50 border border-slate-100 line-through">å·²çµæ¸…</span>`;
                        }

                        return `
                        <div class="bg-white p-5 rounded-[1.8rem] border border-slate-100 flex justify-between items-center shadow-sm">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center ${isMeCreditor ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-500'}">
                                    <i data-lucide="${isMeCreditor ? 'trending-up' : 'trending-down'}" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-[0.15em] mb-1">${l.description || 'å¸³å‹™é …ç›®'}</p>
                                    <p class="font-bold text-sm">
                                        <span class="text-slate-800">${otherName}</span>
                                        <span class="ml-2 font-black ${isMeCreditor ? 'text-emerald-600' : 'text-rose-500'}">$${l.amount.toLocaleString()}</span>
                                    </p>
                                </div>
                            </div>
                            <div>${actionBtn}</div>
                        </div>`
                    }).join('')}
                </div>`;
        }

        // 7. è¨­å®šé é¢ï¼šç·¨è¼¯è³‡æ–™èˆ‡æ”¯ä»˜è³‡è¨Š
        async function renderSettingsPage(container) {
            const { data: p } = await _supabase.from('profiles').select('*').eq('id', currentUser.id).single();
            const { data: gs } = await _supabase.from('groups').select('*');
            const avatar = p?.avatar_url || `https://api.dicebear.com/9.x/avataaars/svg?seed=${p?.username || currentUser.email}`;

            container.innerHTML = `
                <div class="flex flex-col items-center mb-10 pt-4 text-center">
                    <div class="relative w-28 h-28 mb-6 group cursor-pointer" onclick="promptAvatar()">
                        <div class="w-full h-full rounded-full bg-slate-100 p-1 shadow-2xl border-2 border-white overflow-hidden">
                            <img src="${avatar}" class="w-full h-full rounded-full object-cover bg-white">
                        </div>
                        <div class="absolute bottom-1 right-1 bg-slate-900 text-white p-2 rounded-full border-4 border-slate-50"><i data-lucide="camera" class="w-4 h-4"></i></div>
                    </div>
                    <h2 class="text-2xl font-black text-slate-900 tracking-tight">${p?.username || 'æœªè¨­å®šåç¨±'}</h2>
                    <p class="text-xs font-bold text-slate-400 mb-6 uppercase tracking-widest">${currentUser.email}</p>
                    <button onclick="openEditProfile('${p?.username||''}','${p?.birthday||''}','${p?.payment_info||''}')" class="px-8 py-3 bg-slate-900 text-white text-xs font-black rounded-full shadow-xl shadow-slate-200 btn-press">ç·¨è¼¯å€‹äººæª”æ¡ˆ</button>
                </div>

                <div class="space-y-6">
                    <div class="bg-indigo-600 rounded-[2.5rem] p-7 text-white shadow-xl shadow-indigo-100 relative overflow-hidden">
                        <div class="relative z-10">
                            <p class="text-[10px] font-black text-indigo-200 uppercase tracking-widest mb-3">æˆ‘çš„è½‰å¸³è³‡è¨Š (ä»˜æ¬¾äººæœƒçœ‹åˆ°)</p>
                            <p class="text-sm font-bold bg-white/10 p-4 rounded-2xl border border-white/10 break-all leading-relaxed">${p?.payment_info || 'å°šæœªè¨­å®šï¼Œé»æ“Šä¸Šæ–¹ç·¨è¼¯æŒ‰éˆ•é€²è¡Œè¨­å®š'}</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-[2.5rem] p-4 border border-slate-100 shadow-sm overflow-hidden">
                        <h3 class="px-4 text-[10px] font-black text-slate-400 uppercase tracking-widest my-4">My Groups</h3>
                        <div class="space-y-1">
                            ${gs?.map(g => `
                                <div class="flex justify-between items-center p-4 rounded-2xl hover:bg-slate-50 transition-colors">
                                    <span class="font-bold text-sm text-slate-700">${g.name}</span>
                                    <button onclick="shareInvite('${g.invite_code}')" class="text-[10px] font-black text-indigo-600 bg-indigo-50 px-4 py-2 rounded-full uppercase">é‚€è«‹</button>
                                </div>
                            `).join('') || '<div class="p-8 text-center text-xs text-slate-300 italic">å°šæœªåŠ å…¥ç¾¤çµ„</div>'}
                        </div>
                        <div class="p-2 grid grid-cols-2 gap-2 mt-4">
                            <button onclick="openGroupModal('create')" class="py-4 bg-slate-50 rounded-2xl text-xs font-black text-slate-600 btn-press">å»ºç«‹ç¾¤çµ„</button>
                            <button onclick="openGroupModal('join')" class="py-4 bg-slate-50 rounded-2xl text-xs font-black text-slate-600 btn-press">åŠ å…¥ç¾¤çµ„</button>
                        </div>
                    </div>

                    <button onclick="handleLogout()" class="w-full py-5 text-rose-500 font-black text-xs bg-white rounded-[2.2rem] shadow-sm border border-slate-100 btn-press">ç™»å‡ºç•¶å‰å¸³è™Ÿ</button>
                    <p class="text-center text-[10px] font-bold text-slate-200 uppercase tracking-[0.4em] pt-4">GiftFlow v2.0</p>
                </div>`;
        }

        // --- åŠŸèƒ½é‚è¼¯æ ¸å¿ƒ ---

        // é‚„æ¬¾æµç¨‹ (è‡ªå‹•å¸¶å…¥å¸³è™Ÿ + ä¸€éµè¤‡è£½)
        async function updateLedger(id, status, btn) {
            triggerHaptic();
            if (status === 'settling') {
                const { data: ledger } = await _supabase.from('ledgers').select('creditor_id, profiles!creditor_id(username, payment_info)').eq('id', id).single();
                const payInfo = ledger.profiles?.payment_info || "å°æ–¹å°šæœªè¨­å®šè½‰å¸³è³‡è¨Š";
                
                // æ¨¡æ“¬å‰ªè²¼ç°¿è¡Œç‚º
                if (ledger.profiles?.payment_info) {
                    await navigator.clipboard.writeText(payInfo);
                    showToast("å·²è‡ªå‹•è¤‡è£½å°æ–¹å¸³è™Ÿ", 'success');
                }

                const confirmed = confirm(`ç¢ºèªé‚„æ¬¾çµ¦ ${ledger.profiles.username}ï¼Ÿ\n\nè½‰å¸³è³‡è¨Šï¼š${payInfo}\n\næ˜¯å¦å·²è½‰å¸³å®Œæˆï¼Ÿé»æ“Šç¢ºèªå¾Œå°‡é€šçŸ¥å°æ–¹æ”¶æ¬¾ã€‚`);
                if (!confirmed) return;
            }

            setLoading(btn, true);
            const { error } = await _supabase.from('ledgers').update({ status }).eq('id', id);
            if (!error) { 
                if (status === 'settled') triggerConfetti();
                showToast("æ›´æ–°ç‹€æ…‹æˆåŠŸ", 'success'); 
                renderContent(); 
            } else {
                setLoading(btn, false);
                showToast(error.message, 'error');
            }
        }

        // é¡˜æœ›èªé ˜
        async function reserveGift(id, btn) {
            triggerHaptic();
            if (!confirm("èªé ˜å¾Œæœ‹å‹å°‡çœ‹åˆ°è©²é …ç›®å·²è¢«æº–å‚™ä¸­ï¼Œç¢ºå®šèªé ˜ï¼Ÿ")) return;
            
            setLoading(btn, true);
            const { error } = await _supabase.from('gifts').update({ is_reserved: true, reserved_by: currentUser.id }).eq('id', id);
            if (!error) { 
                triggerConfetti();
                showToast("èªé ˜æˆåŠŸï¼åˆ¥å¿˜äº†æº–å‚™é©šå–œ", 'success'); 
                renderContent(); 
            } else {
                setLoading(btn, false);
                showToast("èªé ˜å¤±æ•—", 'error');
            }
        }

        // æª”æ¡ˆç·¨è¼¯
        async function openEditProfile(oldN, oldB, oldP) {
            const newN = prompt("è¼¸å…¥æ–°æš±ç¨±ï¼š", oldN); if (newN === null) return;
            const newB = prompt("è¼¸å…¥ç”Ÿæ—¥ (YYYY-MM-DD)ï¼š", oldB); if (newB === null) return;
            const newP = prompt("è¼¸å…¥è½‰å¸³è³‡è¨Š (éŠ€è¡Œåç¨±/åˆ†è¡Œ/å¸³è™Ÿ)ï¼š", oldP); if (newP === null) return;

            const { error } = await _supabase.from('profiles').update({ username: newN, birthday: newB, payment_info: newP }).eq('id', currentUser.id);
            if (!error) { showToast("å€‹äººæª”æ¡ˆæ›´æ–°æˆåŠŸ", 'success'); renderContent(); updateHeaderAvatar(); }
            else showToast(error.message, 'error');
        }

        // è¡¨å–®æäº¤
        async function handleSubmit(btn) {
            triggerHaptic();
            const name = document.getElementById('add-name').value;
            const amount = document.getElementById('add-amount').value;
            const gid = document.getElementById('add-group-id').value;
            
            if (!name || !gid) return showToast("é …ç›®åç¨±èˆ‡ç¾¤çµ„ç‚ºå¿…å¡«", 'error');

            setLoading(btn, true);
            let err;
            if (currentAddType === 'wishlist') {
                const priority = document.getElementById('add-priority').value;
                const res = await _supabase.from('gifts').insert([{ item_name: name, amount: parseInt(amount)||0, group_id: gid, priority, creator_id: currentUser.id }]);
                err = res.error;
            } else {
                const target = document.getElementById('add-target-member').value;
                if (!target) { setLoading(btn, false); return showToast("è«‹é¸æ“‡å€Ÿè²¸å°è±¡", 'error'); }
                let cred = debtDirection === 'owe_me' ? currentUser.id : target;
                let debt = debtDirection === 'owe_me' ? target : currentUser.id;
                const res = await _supabase.from('ledgers').insert([{ description: name, amount: parseInt(amount)||0, group_id: gid, creditor_id: cred, debtor_id: debt, status: 'pending' }]);
                err = res.error;
            }

            if (!err) {
                showToast("ç™¼ä½ˆç´€éŒ„æˆåŠŸ", 'success');
                closeModal();
                renderContent();
            } else {
                setLoading(btn, false);
                showToast(err.message, 'error');
            }
        }

        // --- è¼”åŠ©å·¥å…· ---

        function setLoading(btn, load) {
            btn.disabled = load;
            if (load) {
                btn.dataset.origin = btn.innerHTML;
                btn.innerHTML = '<div class="spinner mx-auto"></div>';
            } else {
                btn.innerHTML = btn.dataset.origin || btn.innerHTML;
            }
        }

        function showToast(msg, type='info') {
            const t = document.getElementById('toast');
            const icon = type === 'success' ? 'check-circle' : (type === 'error' ? 'x-circle' : 'info');
            const color = type === 'success' ? 'text-emerald-400' : (type === 'error' ? 'text-rose-400' : 'text-blue-400');
            t.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4 ${color}"></i><span>${msg}</span>`;
            t.classList.add('show');
            lucide.createIcons();
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function triggerConfetti() { confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, colors: ['#4f46e5', '#10b981', '#fb7185'] }); }
        function triggerHaptic() { if (navigator.vibrate) navigator.vibrate(12); }
        function calculateDays(d) { if(!d)return 999; const t=new Date(),b=new Date(d); b.setFullYear(t.getFullYear()); if(b<t)b.setFullYear(t.getFullYear()+1); return Math.ceil((b-t)/864e5); }
        function getSkeletonLoader() { return `<div class="space-y-4"><div class="h-40 bg-slate-100 rounded-[2.5rem]"></div><div class="h-20 bg-slate-100 rounded-[1.8rem]"></div><div class="h-20 bg-slate-100 rounded-[1.8rem]"></div></div>`; }
        function renderEmpty(t, d) { return `<div class="flex flex-col items-center justify-center h-80 opacity-40 text-center px-10"><i data-lucide="inbox" class="w-12 h-12 mb-4"></i><h3 class="text-lg font-black">${t}</h3><p class="text-xs font-bold mt-1">${d}</p></div>`; }
        function openAddModal(){ document.getElementById('add-modal').classList.remove('hidden'); }
        function closeModal(){ document.getElementById('add-modal').classList.add('hidden'); }
        function setAddType(t){ currentAddType=t; const isW=t==='wishlist'; document.getElementById('type-wish').className=isW?'flex-1 py-3.5 rounded-xl text-xs font-black bg-white shadow-sm text-indigo-600 transition-all':'flex-1 py-3.5 rounded-xl text-xs font-black text-slate-400 transition-all'; document.getElementById('type-debt').className=!isW?'flex-1 py-3.5 rounded-xl text-xs font-black bg-white shadow-sm text-indigo-600 transition-all':'flex-1 py-3.5 rounded-xl text-xs font-black text-slate-400 transition-all'; document.getElementById('debt-options').classList.toggle('hidden', isW); document.getElementById('add-priority').parentElement.classList.toggle('hidden', !isW); if(!isW) loadGroupMembersForDebt(document.getElementById('add-group-id').value); }
        function setDebtDirection(d){ debtDirection=d; document.getElementById('dir-owe-me').className = d==='owe_me'?'flex-1 py-3 border-2 border-indigo-600 bg-indigo-50 text-indigo-700 rounded-xl text-xs font-bold transition-all':'flex-1 py-3 border-2 border-slate-100 text-slate-400 rounded-xl text-xs font-bold transition-all'; document.getElementById('dir-i-owe').className = d!=='owe_me'?'flex-1 py-3 border-2 border-rose-500 bg-rose-50 text-rose-600 rounded-xl text-xs font-bold transition-all':'flex-1 py-3 border-2 border-slate-100 text-slate-400 rounded-xl text-xs font-bold transition-all'; }
        async function updateHeaderAvatar(){ const{data:p}=await _supabase.from('profiles').select('avatar_url,username').eq('id',currentUser.id).single(); const url=p?.avatar_url||`https://api.dicebear.com/9.x/avataaars/svg?seed=${p?.username||currentUser.email}`; document.getElementById('header-avatar').innerHTML=`<img src="${url}" class="w-full h-full object-cover">`; }
        async function handleLogout(){ await _supabase.auth.signOut(); window.location.reload(); }
        async function loadGroupsToSelect(){ const{data}=await _supabase.from('groups').select('*'); const s=document.getElementById('add-group-id'); if(s){ s.innerHTML='<option value="">é¸æ“‡ç¾¤çµ„</option>'; data?.forEach(g=>s.innerHTML+=`<option value="${g.id}">${g.name}</option>`); } }
        async function loadGroupMembersForDebt(gid){ const{data:ms}=await _supabase.from('group_members').select('user_id,profiles(username)').eq('group_id',gid); const s=document.getElementById('add-target-member'); s.innerHTML=''; ms?.filter(m=>m.user_id!==currentUser.id).forEach(m=>s.innerHTML+=`<option value="${m.user_id}">${m.profiles?.username||'User'}</option>`); }
        async function promptAvatar(){ const url=prompt("è¼¸å…¥åœ–ç‰‡é€£çµï¼š"); if(url!==null){ const{error}=await _supabase.from('profiles').update({avatar_url:url.trim()||null}).eq('id',currentUser.id); if(!error) renderContent(); updateHeaderAvatar(); } }
        async function joinGroupLogic(code){ const{data:g}=await _supabase.from('groups').select('id').eq('invite_code',code).single(); if(!g) return showToast("ç„¡æ•ˆé‚€è«‹ç¢¼", 'error'); const{error}=await _supabase.from('group_members').insert([{group_id:g.id, user_id:currentUser.id}]); if(!error){ showToast("å·²æˆåŠŸåŠ å…¥ç¾¤çµ„", 'success'); renderContent(); loadGroupsToSelect(); } }
        function shareInvite(c){ const url=`${window.location.origin}${window.location.pathname}?invite=${c}`; if(navigator.share) navigator.share({title:'åŠ å…¥æˆ‘çš„ GiftFlow ç¾¤çµ„', url}); else { navigator.clipboard.writeText(url); showToast("é‚€è«‹é€£çµå·²è¤‡è£½", 'success'); } }
        function openGroupModal(act){ if(act==='create'){ const n=prompt("è¼¸å…¥ç¾¤çµ„åç¨±ï¼š"); if(n) createGroupLogic(n); } else { const c=prompt("è¼¸å…¥ 6 ç¢¼é‚€è«‹ç¢¼ï¼š"); if(c) joinGroupLogic(c); } }
        async function createGroupLogic(name){ const{data:g,error}=await _supabase.from('groups').insert([{name, creator_id:currentUser.id}]).select().single(); if(!error){ await _supabase.from('group_members').insert([{group_id:g.id, user_id:currentUser.id, role:'admin'}]); showToast("ç¾¤çµ„å»ºç«‹æˆåŠŸ", 'success'); renderContent(); loadGroupsToSelect(); } }
        function syncCalendar(n,b){ if(!b) return showToast("å°æ–¹æœªè¨­å®šç”Ÿæ—¥", 'error'); const t=new Date(),[y,m,d]=b.split('-'); let ny=t.getFullYear(); if(new Date(ny,m-1,d)<t) ny++; const ds=`${ny}${m}${d}`; window.open(`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${n}ç”Ÿæ—¥&dates=${ds}/${ds}`,'_blank'); }
    </script>
</body>
</html>
