<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>GIFTFLOW PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkdJRlRGTE9XIiwKICAic2hvcnRfbmFtZSI6ICJHSUZURkxPVyIsCiAgInN0YXJ0X3VybCI6ICIvIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmZmZmIiwKICAidGhlbWVfY29sb3IiOiAiIzRmNDZlNSIKfQ==">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(241, 245, 249, 0.5); }
        .safe-bottom { padding-bottom: calc(env(safe-area-inset-bottom) + 20px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(15, 23, 42, 0.9); color: white; padding: 10px 24px; border-radius: 99px; font-size: 13px; font-weight: bold; opacity: 0; transition: all 0.3s; pointer-events: none; z-index: 9999; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
        .skeleton { background: #f1f5f9; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; border-radius: 12px; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 overflow-x-hidden select-none">

    <div id="toast" class="toast">Action Successful</div>

    <div id="login-screen" class="flex flex-col items-center justify-center min-h-screen p-6 relative z-50 bg-slate-50">
        <div class="w-full max-w-md bg-white rounded-[2.5rem] shadow-xl p-10 text-center border border-slate-100">
            <div class="w-16 h-16 bg-indigo-600 rounded-2xl mx-auto mb-6 flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                <i data-lucide="gift" class="w-8 h-8"></i>
            </div>
            <h1 class="text-2xl font-black mb-2 tracking-tight">GIFTFLOW</h1>
            <p class="text-xs font-bold text-slate-400 mb-8 uppercase tracking-widest">Login to continue</p>
            <form id="auth-form" class="space-y-4 text-left">
                <input type="email" id="email" placeholder="Email" required class="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold text-sm focus:ring-2 ring-indigo-100 transition-all">
                <input type="password" id="password" placeholder="Password" required class="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold text-sm focus:ring-2 ring-indigo-100 transition-all">
                <div class="flex gap-3 mt-4">
                    <button type="button" onclick="handleAuth('login')" class="flex-1 py-4 bg-slate-900 text-white font-bold rounded-2xl shadow-lg active:scale-95 transition-transform">ç™»å…¥</button>
                    <button type="button" onclick="handleAuth('signup')" class="flex-1 py-4 bg-white border border-slate-200 text-slate-900 font-bold rounded-2xl shadow-sm active:scale-95 transition-transform">è¨»å†Š</button>
                </div>
            </form>
        </div>
    </div>

    <div id="main-app" class="hidden max-w-md mx-auto min-h-screen flex flex-col">
        <header class="px-6 py-4 sticky top-0 z-40 flex justify-between items-center glass">
            <h1 class="text-xl font-black italic text-indigo-600 tracking-tighter cursor-pointer" onclick="switchTab('dashboard')">GIFTFLOW</h1>
            <button onclick="switchTab('settings')" class="relative group active:scale-95 transition-transform">
                <div id="header-avatar" class="w-9 h-9 rounded-full bg-slate-200 overflow-hidden border-2 border-white shadow-sm ring-2 ring-slate-100"></div>
            </button>
        </header>

        <main id="content" class="p-6 flex-1 pb-32 overflow-y-auto hide-scrollbar">
            </main>

        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto glass border-t border-slate-100 px-8 pt-4 pb-8 flex justify-between items-center z-40 safe-bottom">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-btn opacity-30"><i data-lucide="calendar-days"></i></button>
            <button onclick="switchTab('gifts')" id="nav-gifts" class="nav-btn opacity-30"><i data-lucide="gift"></i></button>
            <div class="relative -top-8">
                <button onclick="openAddModal()" class="bg-indigo-600 text-white p-5 rounded-full shadow-xl shadow-indigo-300 ring-8 ring-white active:scale-95 transition-transform"><i data-lucide="plus" class="w-7 h-7"></i></button>
            </div>
            <button onclick="switchTab('ledgers')" id="nav-ledgers" class="nav-btn opacity-30"><i data-lucide="wallet"></i></button>
            <button onclick="switchTab('settings')" id="nav-settings" class="nav-btn opacity-30"><i data-lucide="user-circle"></i></button>
        </nav>
    </div>

    <div id="add-modal" class="hidden fixed inset-0 z-50 bg-slate-900/60 backdrop-blur-sm flex items-end justify-center sm:items-center p-0 sm:p-4 transition-opacity duration-300">
        <div class="bg-white w-full max-w-md rounded-t-[2.5rem] sm:rounded-[2.5rem] p-8 shadow-2xl animate-in slide-in-from-bottom duration-300">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black text-slate-800">New Item</h2>
                <button onclick="closeModal()" class="p-2 bg-slate-50 rounded-full hover:bg-slate-100"><i data-lucide="x" class="w-5 h-5 text-slate-500"></i></button>
            </div>
            
            <div class="flex p-1.5 bg-slate-100 rounded-2xl mb-6">
                <button onclick="setAddType('wishlist')" id="type-wish" class="flex-1 py-3 rounded-xl text-xs font-black bg-white shadow-sm text-indigo-600 transition-all">ğŸ é¡˜æœ›</button>
                <button onclick="setAddType('debt')" id="type-debt" class="flex-1 py-3 rounded-xl text-xs font-black text-slate-400 transition-all">ğŸ’¸ è¨˜å¸³</button>
            </div>

            <form id="add-form" class="space-y-4">
                <input type="text" id="add-name" placeholder="é …ç›®åç¨±" required class="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold text-sm focus:ring-2 ring-indigo-100">
                <div class="flex gap-3">
                    <input type="number" id="add-amount" placeholder="é‡‘é¡" class="flex-1 p-4 bg-slate-50 rounded-2xl outline-none font-bold text-sm focus:ring-2 ring-indigo-100">
                    <select id="add-priority" class="flex-1 p-4 bg-slate-50 rounded-2xl outline-none font-bold text-xs text-slate-600">
                        <option value="normal">æ¬Šé‡: ä¸€èˆ¬</option>
                        <option value="high">ğŸ”¥ æ¥µåº¦æƒ³è¦</option>
                        <option value="low">â˜• éš¨ç·£</option>
                    </select>
                </div>
                <select id="add-group-id" class="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold text-sm text-indigo-600 bg-indigo-50/50" onchange="loadGroupMembersForDebt(this.value)"></select>
                
                <div id="debt-options" class="hidden space-y-3 pt-2">
                    <div class="flex gap-2 text-[10px] font-bold text-slate-400 uppercase tracking-wider px-2">å€Ÿè²¸æ–¹å‘</div>
                    <div class="flex gap-2">
                        <button type="button" onclick="setDebtDirection('owe_me')" id="dir-owe-me" class="flex-1 py-3 border-2 border-indigo-600 bg-indigo-50 text-indigo-700 rounded-xl text-xs font-bold transition-all">åˆ¥äººæ¬ æˆ‘</button>
                        <button type="button" onclick="setDebtDirection('i_owe')" id="dir-i-owe" class="flex-1 py-3 border-2 border-slate-100 text-slate-400 rounded-xl text-xs font-bold transition-all">æˆ‘æ¬ åˆ¥äºº</button>
                    </div>
                    <select id="add-target-member" class="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold text-sm text-slate-700"></select>
                </div>

                <button type="button" onclick="handleSubmit()" class="w-full py-4 bg-slate-900 text-white font-bold rounded-2xl shadow-xl mt-4 active:scale-95 transition-transform">ç™¼ä½ˆç´€éŒ„</button>
            </form>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://kzzxyyykpiquanxtfkwr.supabase.co'; 
        const supabaseKey = 'sb_publishable_K0ThQ9_ZqPPYk0sxxWgLhg_qwzuMNeG'; 
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let activeTab = 'dashboard';
        let currentAddType = 'wishlist';
        let debtDirection = 'owe_me'; 

        // 1. åˆå§‹åŒ–
        window.onload = async () => {
            // æª¢æŸ¥ URL é‚€è«‹ç¢¼
            const urlParams = new URLSearchParams(window.location.search);
            const inviteCode = urlParams.get('invite');
            if (inviteCode) localStorage.setItem('pending_invite', inviteCode);

            const { data: { session } } = await _supabase.auth.getSession();
            if (session) { 
                currentUser = session.user; 
                showApp();
                // è™•ç†å»¶é²åŠ å…¥
                const pending = localStorage.getItem('pending_invite');
                if (pending) { joinGroupLogic(pending); localStorage.removeItem('pending_invite'); }
            }
            lucide.createIcons();
        };

        // 2. Auth åˆ†é›¢
        async function handleAuth(type) {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            if (!email || !password) return showToast("è«‹è¼¸å…¥ Email èˆ‡å¯†ç¢¼");

            let res;
            if (type === 'login') {
                res = await _supabase.auth.signInWithPassword({ email, password });
            } else {
                res = await _supabase.auth.signUp({ email, password });
            }

            if (res.error) showToast(res.error.message);
            else if (type === 'signup') showToast("è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥ï¼");
            else {
                currentUser = res.data.user;
                showApp();
            }
        }

        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            updateHeaderAvatar();
            switchTab('dashboard');
            loadGroupsToSelect();
        }

        // 3. Render Content (å« Skeleton)
        async function renderContent() {
            const container = document.getElementById('content');
            
            // Skeleton Loading
            container.innerHTML = `
                <div class="space-y-4 animate-pulse">
                    <div class="h-32 bg-slate-100 rounded-[2rem]"></div>
                    <div class="h-20 bg-slate-100 rounded-[2rem]"></div>
                    <div class="h-20 bg-slate-100 rounded-[2rem]"></div>
                </div>`;

            if (activeTab === 'dashboard') {
                const { data: members } = await _supabase.from('group_members').select('*, profiles(*)');
                if (!members || members.length === 0) return renderEmpty('å°šç„¡å¥½å‹', 'å»è¨­å®šé é¢å»ºç«‹ç¾¤çµ„å§ï¼');

                const sorted = members
                    .filter(m => m.user_id !== currentUser.id)
                    .map(m => ({ ...m, days: calculateDays(m.profiles?.birthday) }))
                    .sort((a, b) => a.days - b.days);

                container.innerHTML = `
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-black text-slate-800">Upcoming</h2>
                        <span class="text-[10px] font-bold bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full">SORTED</span>
                    </div>
                    <div class="space-y-3">
                        ${sorted.map(m => `
                            <div class="bg-white p-4 rounded-[1.5rem] shadow-sm border border-slate-100 flex justify-between items-center">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-slate-100 overflow-hidden">
                                        <img src="${m.profiles?.avatar_url || `https://api.dicebear.com/9.x/avataaars/svg?seed=${m.profiles?.username}`}" class="w-full h-full object-cover">
                                    </div>
                                    <div>
                                        <p class="font-bold text-sm">${m.nickname || m.profiles?.username || 'User'}</p>
                                        <button onclick="syncCalendar('${m.nickname}', '${m.profiles?.birthday}')" class="text-[10px] font-bold text-indigo-400 uppercase flex items-center gap-1">
                                            <i data-lucide="calendar-plus" class="w-3 h-3"></i> Add to Calendar
                                        </button>
                                    </div>
                                </div>
                                <div class="text-right"><p class="text-xl font-black text-indigo-600">${m.days}<span class="text-[10px] ml-0.5 text-slate-400 font-bold">DAYS</span></p></div>
                            </div>
                        `).join('')}
                    </div>`;

            } else if (activeTab === 'ledgers') {
                const { data: ledgers } = await _supabase.from('ledgers').select('*, creditor:profiles!creditor_id(username), debtor:profiles!debtor_id(username)').order('created_at', { ascending: false });
                
                if (!ledgers || ledgers.length === 0) return renderEmpty('æ²’æœ‰å¸³å‹™', 'å¥½æœ‹å‹æ˜ç®—å¸³ï¼Œç´€éŒ„ç¬¬ä¸€ç­†å§ï¼');

                container.innerHTML = `
                    <h2 class="text-xl font-black text-slate-800 mb-6">Ledgers</h2>
                    <div class="space-y-3">
                        ${ledgers.map(l => {
                            const isMeCreditor = l.creditor_id === currentUser.id;
                            const otherName = isMeCreditor ? (l.debtor?.username || 'å°æ–¹') : (l.creditor?.username || 'å°æ–¹');
                            
                            // ç‹€æ…‹é¡¯ç¤ºé‚è¼¯
                            let actionBtn = '';
                            if (l.status === 'pending') {
                                if (!isMeCreditor) actionBtn = `<button onclick="updateLedger('${l.id}', 'confirmed')" class="text-[10px] font-bold bg-emerald-500 text-white px-3 py-1.5 rounded-full shadow-sm">ç¢ºèª</button>`;
                                else actionBtn = `<span class="text-[10px] font-bold text-amber-500 bg-amber-50 px-2 py-1 rounded-full">å¾…ç¢ºèª</span>`;
                            } else if (l.status === 'confirmed') {
                                if (!isMeCreditor) actionBtn = `<button onclick="updateLedger('${l.id}', 'settling')" class="text-[10px] font-bold bg-indigo-500 text-white px-3 py-1.5 rounded-full shadow-sm">é‚„æ¬¾</button>`;
                                else actionBtn = `<span class="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-full">å·²ç¢ºèª</span>`;
                            } else if (l.status === 'settling') {
                                if (isMeCreditor) actionBtn = `<button onclick="updateLedger('${l.id}', 'settled')" class="text-[10px] font-bold bg-indigo-600 text-white px-3 py-1.5 rounded-full shadow-sm">ç¢ºèªæ”¶æ¬¾</button>`;
                                else actionBtn = `<span class="text-[10px] font-bold text-indigo-500 bg-indigo-50 px-2 py-1 rounded-full">é‚„æ¬¾ç¢ºèªä¸­</span>`;
                            } else {
                                actionBtn = `<span class="text-[10px] font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded-full">å·²çµæ¸…</span>`;
                            }

                            return `
                            <div class="bg-white p-5 rounded-[1.5rem] border ${l.status==='settled' ? 'border-slate-100 opacity-60' : 'border-slate-200'} flex justify-between items-center">
                                <div>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">${l.description || 'å¸³å‹™'}</p>
                                    <p class="font-bold text-sm flex items-center gap-1">
                                        <span class="${isMeCreditor ? 'text-emerald-600' : 'text-rose-500'}">${isMeCreditor ? 'æ”¶' : 'ä»˜'}</span>
                                        <span class="text-slate-700">${otherName}</span>
                                        <span class="text-slate-900 ml-1">$${l.amount}</span>
                                    </p>
                                </div>
                                <div>${actionBtn}</div>
                            </div>`
                        }).join('')}
                    </div>`;
            } else if (activeTab === 'settings') {
                 // è¨­å®šé é¢é‚è¼¯ä¿æŒä¸è®Š (è«‹è¤‡è£½ä¹‹å‰æä¾›çš„ iOS é¢¨æ ¼è¨­å®šé ä»£ç¢¼)
                 renderSettingsPage(container);
            } else if (activeTab === 'gifts') {
                 // ç¦®ç‰©é‚è¼¯ä¿æŒä¸è®Š
                 renderGiftsPage(container);
            }
            lucide.createIcons();
        }

        // Settings é é¢æ¸²æŸ“
        async function renderSettingsPage(container) {
            const { data: profile } = await _supabase.from('profiles').select('*').eq('id', currentUser.id).single();
            const { data: myGroups } = await _supabase.from('groups').select('*');
            const avatarUrl = profile?.avatar_url || `https://api.dicebear.com/9.x/avataaars/svg?seed=${profile?.username || currentUser.email}`;

            container.innerHTML = `
                <div class="flex flex-col items-center mb-8 pt-4">
                    <div class="relative mb-4 group cursor-pointer" onclick="promptAvatar()">
                        <div class="w-24 h-24 rounded-full bg-slate-100 p-1 shadow-lg border border-slate-100 overflow-hidden relative">
                            <img src="${avatarUrl}" class="w-full h-full rounded-full object-cover bg-white">
                            <div class="absolute inset-0 bg-black/30 hidden group-hover:flex items-center justify-center rounded-full text-white text-xs font-bold">æ›´æ›</div>
                        </div>
                    </div>
                    <h2 class="text-xl font-black text-slate-900">${profile?.username || 'æœªè¨­å®šæš±ç¨±'}</h2>
                    <p class="text-xs font-bold text-slate-400 mb-4">${currentUser.email}</p>
                    <button onclick="openEditProfile('${profile?.username||''}', '${profile?.birthday||''}')" class="px-5 py-2 bg-slate-900 text-white text-xs font-bold rounded-full shadow-lg active:scale-95 transition-transform">ç·¨è¼¯è³‡æ–™</button>
                </div>
                <div class="mb-6">
                    <h3 class="px-4 text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">My Groups</h3>
                    <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden">
                        ${myGroups && myGroups.length > 0 ? myGroups.map(g => `
                            <div class="flex justify-between items-center p-4 border-b border-slate-50 last:border-0">
                                <span class="font-bold text-sm text-slate-700">${g.name}</span>
                                <button onclick="shareInvite('${g.invite_code}')" class="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded">é‚€è«‹</button>
                            </div>
                        `).join('') : '<div class="p-4 text-center text-xs text-slate-300">ç„¡ç¾¤çµ„</div>'}
                        <div class="p-2 flex gap-2 bg-slate-50/50">
                            <button onclick="openGroupModal('create')" class="flex-1 py-3 bg-white rounded-xl text-xs font-bold text-indigo-600 shadow-sm">å»ºç«‹</button>
                            <button onclick="openGroupModal('join')" class="flex-1 py-3 bg-white rounded-xl text-xs font-bold text-slate-600 shadow-sm">åŠ å…¥</button>
                        </div>
                    </div>
                </div>
                <button onclick="handleLogout()" class="w-full py-4 text-rose-500 font-bold text-xs bg-white rounded-2xl shadow-sm border border-slate-100">ç™»å‡ºå¸³è™Ÿ</button>
            `;
        }

        async function renderGiftsPage(container) {
             const { data: gifts } = await _supabase.from('gifts').select('*').order('created_at', { ascending: false });
             if (!gifts || gifts.length === 0) return renderEmpty('é¡˜æœ›æ¸…å–®æ˜¯ç©ºçš„', 'æ–°å¢ä¸€å€‹é¡˜æœ›ï¼Œè®“æœ‹å‹çµ¦ä½ é©šå–œï¼');
             container.innerHTML = `
                <h2 class="text-xl font-black text-slate-800 mb-6">Wishlist</h2>
                <div class="grid grid-cols-1 gap-3">
                    ${gifts.map(g => {
                        const isMine = g.creator_id === currentUser.id;
                        return `
                        <div class="bg-white p-5 rounded-[1.5rem] border border-slate-100 shadow-sm flex justify-between items-center">
                            <div>
                                <p class="font-bold text-slate-800 text-sm">${g.item_name} ${g.priority === 'high' ? 'ğŸ”¥' : ''}</p>
                                <p class="text-xs font-bold text-slate-400 mt-0.5">$ ${g.amount.toLocaleString()}</p>
                            </div>
                            <div>
                                ${isMine ? 
                                    `<span class="text-[10px] font-bold text-slate-300 bg-slate-50 px-3 py-1.5 rounded-full">${g.is_reserved ? 'å·²è¢«èªé ˜ ğŸ¤«' : 'ç­‰å¾…ä¸­'}</span>` : 
                                    (g.is_reserved ? 
                                        `<span class="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-3 py-1.5 rounded-full">å·²èªé ˜</span>` : 
                                        `<button onclick="reserveGift('${g.id}', this)" class="text-[10px] font-bold bg-slate-900 text-white px-4 py-2 rounded-full active:scale-95">èªé ˜</button>`
                                    )
                                }
                            </div>
                        </div>`;
                    }).join('')}
                </div>`;
        }

        // --- é‚è¼¯åŠŸèƒ½ ---

        async function updateLedger(id, status) {
            const { error } = await _supabase.from('ledgers').update({ status }).eq('id', id);
            if (!error) { showToast("ç‹€æ…‹å·²æ›´æ–°"); renderContent(); }
        }

        async function createGroupLogic(name) {
            const { data: group, error } = await _supabase.from('groups').insert([{ name, creator_id: currentUser.id }]).select().single();
            if (!error) {
                await _supabase.from('group_members').insert([{ group_id: group.id, user_id: currentUser.id, role: 'admin' }]);
                showToast("å»ºç«‹æˆåŠŸ"); renderContent(); loadGroupsToSelect();
            } else showToast(error.message);
        }

        async function joinGroupLogic(code) {
            const { data: group } = await _supabase.from('groups').select('id').eq('invite_code', code).single();
            if (!group) return showToast("é‚€è«‹ç¢¼ç„¡æ•ˆ");
            const { error } = await _supabase.from('group_members').insert([{ group_id: group.id, user_id: currentUser.id }]);
            if (!error) { showToast("æˆåŠŸåŠ å…¥"); renderContent(); loadGroupsToSelect(); }
            else showToast("ä½ å·²ç¶“åœ¨è©²ç¾¤çµ„äº†");
        }

        // åˆ†äº«é‚€è«‹é€£çµ
        function shareInvite(code) {
            const url = `${window.location.origin}${window.location.pathname}?invite=${code}`;
            if(navigator.share) navigator.share({title:'Join my GiftFlow Group', url});
            else { navigator.clipboard.writeText(url); showToast("é€£çµå·²è¤‡è£½"); }
        }
        
        // è¼”åŠ©å‡½å¼ (ä¿ç•™ä¹‹å‰çš„)
        function renderEmpty(t, d) { return `<div class="flex flex-col items-center justify-center h-full opacity-40 mt-10"><i data-lucide="ghost" class="w-12 h-12 mb-4"></i><h3 class="text-lg font-black">${t}</h3><p class="text-xs font-bold">${d}</p></div>`; }
        function calculateDays(d) { if(!d)return 999; const t=new Date(),b=new Date(d); b.setFullYear(t.getFullYear()); if(b<t)b.setFullYear(t.getFullYear()+1); return Math.ceil((b-t)/864e5); }
        function syncCalendar(n,b){ if(!b)return showToast("ç„¡ç”Ÿæ—¥"); const t=new Date(),[y,m,d]=b.split('-'); let ny=t.getFullYear(); if(new Date(ny,m-1,d)<t)ny++; const ds=`${ny}${m}${d}`; window.open(`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${n}ç”Ÿæ—¥&dates=${ds}/${ds}`,'_blank'); }
        function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
        function switchTab(t) { activeTab = t; document.querySelectorAll('.nav-btn').forEach(b=>b.classList.add('opacity-30')); document.getElementById('nav-'+t).classList.remove('opacity-30'); renderContent(); }
        
        // Modal & Auth
        function openAddModal(){document.getElementById('add-modal').classList.remove('hidden');}
        function closeModal(){document.getElementById('add-modal').classList.add('hidden');}
        async function handleLogout(){await _supabase.auth.signOut();window.location.reload();}
        async function updateHeaderAvatar(){const{data:p}=await _supabase.from('profiles').select('avatar_url,username').eq('id',currentUser.id).single(); const url=p?.avatar_url||`https://api.dicebear.com/9.x/avataaars/svg?seed=${p?.username||currentUser.email}`; document.getElementById('header-avatar').innerHTML=`<img src="${url}" class="w-full h-full object-cover">`;}
        
        // è¼‰å…¥ç¾¤çµ„èˆ‡æˆå“¡
        async function loadGroupsToSelect(){const{data}=await _supabase.from('groups').select('*'); const s=document.getElementById('add-group-id'); if(s){s.innerHTML='<option value="">é¸æ“‡ç¾¤çµ„</option>';data?.forEach(g=>s.innerHTML+=`<option value="${g.id}">${g.name}</option>`)}}
        async function loadGroupMembersForDebt(gid){
            if(currentAddType!=='debt'||!gid)return;
            const{data:ms}=await _supabase.from('group_members').select('user_id,profiles(username)').eq('group_id',gid);
            const s=document.getElementById('add-target-member'); s.innerHTML='';
            ms?.filter(m=>m.user_id!==currentUser.id).forEach(m=>s.innerHTML+=`<option value="${m.user_id}">${m.profiles?.username||'User'}</option>`);
        }
        
        // è¡¨å–®æäº¤ (ç•¥ä½œä¿®æ”¹ä»¥é©æ‡‰æ–°é‚è¼¯)
        async function handleSubmit() {
            // ... (è«‹æ²¿ç”¨å‰ä¸€ç‰ˆçš„ handleSubmit é‚è¼¯ï¼Œéœ€åŒ…å« debtDirection åˆ¤æ–·) ...
            const name = document.getElementById('add-name').value;
            const amount = document.getElementById('add-amount').value;
            const groupId = document.getElementById('add-group-id').value;
            if (!name || !groupId) return showToast("è³‡è¨Šä¸å®Œæ•´");

            let error;
            if (currentAddType === 'wishlist') {
                const priority = document.getElementById('add-priority').value;
                const res = await _supabase.from('gifts').insert([{ item_name: name, amount: parseInt(amount)||0, group_id: groupId, priority, creator_id: currentUser.id }]);
                error = res.error;
            } else {
                const targetId = document.getElementById('add-target-member').value;
                if (!targetId) return showToast("è«‹é¸æ“‡å°è±¡");
                let creditor = debtDirection === 'owe_me' ? currentUser.id : targetId;
                let debtor = debtDirection === 'owe_me' ? targetId : currentUser.id;
                const res = await _supabase.from('ledgers').insert([{ description: name, amount: parseInt(amount)||0, group_id: groupId, creditor_id: creditor, debtor_id: debtor }]);
                error = res.error;
            }
            if (!error) { showToast("ç™¼ä½ˆæˆåŠŸ"); closeModal(); renderContent(); } else showToast(error.message);
        }

        // Type åˆ‡æ›
        function setAddType(t) {
            currentAddType = t;
            const isW = t === 'wishlist';
            document.getElementById('type-wish').className = isW ? 'flex-1 py-3 rounded-xl text-xs font-black bg-white shadow-sm text-indigo-600 transition-all' : 'flex-1 py-3 rounded-xl text-xs font-black text-slate-400 transition-all';
            document.getElementById('type-debt').className = !isW ? 'flex-1 py-3 rounded-xl text-xs font-black bg-white shadow-sm text-indigo-600 transition-all' : 'flex-1 py-3 rounded-xl text-xs font-black text-slate-400 transition-all';
            document.getElementById('add-priority').parentElement.classList.toggle('hidden', !isW);
            document.getElementById('debt-options').classList.toggle('hidden', isW);
            if(!isW) loadGroupMembersForDebt(document.getElementById('add-group-id').value);
        }
        function setDebtDirection(d){
            debtDirection=d;
            document.getElementById('dir-owe-me').className = d==='owe_me'?'flex-1 py-3 border-2 border-indigo-600 bg-indigo-50 text-indigo-700 rounded-xl text-xs font-bold transition-all':'flex-1 py-3 border-2 border-slate-100 text-slate-400 rounded-xl text-xs font-bold transition-all';
            document.getElementById('dir-i-owe').className = d!=='owe_me'?'flex-1 py-3 border-2 border-slate-100 bg-rose-50 text-rose-600 rounded-xl text-xs font-bold transition-all':'flex-1 py-3 border-2 border-slate-100 text-slate-400 rounded-xl text-xs font-bold transition-all';
        }
    </script>
</body>
</html>
