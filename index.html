<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>GIFTFLOW PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.5); }
        .safe-bottom { padding-bottom: calc(env(safe-area-inset-bottom) + 20px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        /* Toast é€šçŸ¥ä¿®æ­£ä½ç½® */
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: rgba(15, 23, 42, 0.95); color: white; padding: 12px 28px; border-radius: 99px; font-size: 13px; font-weight: bold; opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none; z-index: 9999; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.3); white-space: nowrap; display: flex; align-items: center; gap: 8px; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        .btn-press:active { transform: scale(0.96); }
        .spinner { width: 1.2em; height: 1.2em; border: 2px solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spin .75s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* å½ˆçª—ç½®ä¸­ä¿®æ­£ */
        .modal-overlay { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 1rem; }
        .modal-content { max-height: 90vh; overflow-y: auto; }

        .priority-high { position: relative; overflow: hidden; }
        .priority-high::before { content: ''; position: absolute; inset: 0; padding: 2px; border-radius: 1.5rem; background: linear-gradient(45deg, #fb7185, #a78bfa); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; opacity: 0.6; }
        .snap-x-mandatory { scroll-snap-type: x mandatory; }
        .snap-center { scroll-snap-align: center; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 overflow-x-hidden select-none">

    <div id="toast" class="toast"><i data-lucide="check-circle" class="w-4 h-4 text-emerald-400"></i><span id="toast-msg">Action Successful</span></div>

    <div id="login-screen" class="flex flex-col items-center justify-center min-h-screen p-6 relative z-50 bg-slate-50 transition-opacity duration-500">
        <div class="w-full max-w-md bg-white rounded-[2.5rem] shadow-xl p-10 text-center border border-slate-100">
            <div class="w-20 h-20 bg-indigo-600 rounded-[2rem] mx-auto mb-8 flex items-center justify-center text-white shadow-xl shadow-indigo-200 transform hover:scale-105 transition-transform duration-300">
                <i data-lucide="gift" class="w-10 h-10"></i>
            </div>
            <h1 class="text-3xl font-black mb-2 tracking-tight text-slate-900">GIFTFLOW</h1>
            <p class="text-xs font-bold text-slate-400 mb-10 uppercase tracking-[0.2em]">Social Finance & Wishlist</p>
            <form id="auth-form" class="space-y-4 text-left">
                <div class="space-y-4">
                    <input type="email" id="email" placeholder="Email" required class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:bg-white focus:border-indigo-600 transition-all font-bold text-sm placeholder:text-slate-300">
                    <input type="password" id="password" placeholder="Password" required class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:bg-white focus:border-indigo-600 transition-all font-bold text-sm placeholder:text-slate-300">
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="handleAuth('login', this)" class="flex-1 py-4 bg-slate-900 text-white font-bold rounded-2xl shadow-lg active:scale-95 transition-all hover:bg-black">ç™»å…¥</button>
                    <button type="button" onclick="handleAuth('signup', this)" class="flex-1 py-4 bg-white border border-slate-200 text-slate-900 font-bold rounded-2xl shadow-sm active:scale-95 transition-all hover:bg-slate-50">è¨»å†Š</button>
                </div>
            </form>
        </div>
    </div>

    <div id="main-app" class="hidden max-w-md mx-auto min-h-screen flex flex-col pb-safe">
        <header class="px-6 py-4 sticky top-0 z-40 flex justify-between items-center glass">
            <div class="flex items-center gap-2 active:opacity-70 transition-opacity cursor-pointer" onclick="switchTab('dashboard')">
                <div class="w-2 h-2 bg-indigo-600 rounded-full animate-pulse"></div>
                <h1 class="text-xl font-black italic text-indigo-600 tracking-tighter">GIFTFLOW</h1>
            </div>
            <button onclick="switchTab('settings')" class="relative group btn-press">
                <div id="header-avatar" class="w-9 h-9 rounded-full bg-slate-200 overflow-hidden border-2 border-white shadow-sm ring-2 ring-slate-100 transition-all hover:ring-indigo-200"></div>
            </button>
        </header>

        <main id="content" class="p-6 flex-1 pb-32 overflow-y-auto hide-scrollbar space-y-6">
            </main>

        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto glass border-t border-slate-100 px-8 pt-4 pb-8 flex justify-between items-center z-40 safe-bottom">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-btn opacity-40 hover:opacity-100 transition-all"><i data-lucide="layout-grid" class="w-6 h-6"></i></button>
            <button onclick="switchTab('gifts')" id="nav-gifts" class="nav-btn opacity-40 hover:opacity-100 transition-all"><i data-lucide="gift" class="w-6 h-6"></i></button>
            <div class="relative -top-8">
                <button onclick="openAddModal()" class="bg-indigo-600 text-white p-5 rounded-full shadow-2xl shadow-indigo-300 ring-8 ring-white btn-press transition-transform hover:bg-indigo-700 hover:scale-105 hover:rotate-90 duration-300"><i data-lucide="plus" class="w-7 h-7"></i></button>
            </div>
            <button onclick="switchTab('ledgers')" id="nav-ledgers" class="nav-btn opacity-40 hover:opacity-100 transition-all"><i data-lucide="wallet" class="w-6 h-6"></i></button>
            <button onclick="switchTab('settings')" id="nav-settings" class="nav-btn opacity-40 hover:opacity-100 transition-all"><i data-lucide="user-circle" class="w-6 h-6"></i></button>
        </nav>
    </div>

    <div id="add-modal" class="hidden fixed inset-0 z-50 bg-slate-900/60 backdrop-blur-md modal-overlay transition-opacity duration-300">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl modal-content animate-in zoom-in-95 duration-200">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-black text-slate-800 tracking-tight">Create New</h2>
                <button onclick="closeModal()" class="p-2 bg-slate-50 rounded-full hover:bg-slate-100 transition-colors"><i data-lucide="x" class="w-6 h-6 text-slate-500"></i></button>
            </div>
            
            <div class="flex p-1.5 bg-slate-100 rounded-2xl mb-8">
                <button onclick="setAddType('wishlist')" id="type-wish" class="flex-1 py-3.5 rounded-xl text-xs font-black bg-white shadow-sm text-indigo-600 transition-all">ğŸ é¡˜æœ›æ¸…å–®</button>
                <button onclick="setAddType('debt')" id="type-debt" class="flex-1 py-3.5 rounded-xl text-xs font-black text-slate-400 transition-all">ğŸ’¸ è¨˜å¸³åˆ†æ”¤</button>
            </div>

            <form id="add-form" class="space-y-5">
                <input type="text" id="add-name" placeholder="é …ç›®åç¨± (ä¾‹å¦‚: æ™šé¤ã€AirPods)" required class="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold text-sm focus:bg-white focus:ring-2 ring-indigo-100 transition-all placeholder:font-normal">
                
                <div class="flex gap-4">
                    <input type="number" id="add-amount" placeholder="é‡‘é¡" class="flex-1 p-4 bg-slate-50 rounded-2xl outline-none font-bold text-sm focus:bg-white focus:ring-2 ring-indigo-100 transition-all placeholder:font-normal">
                    <select id="add-priority" class="flex-1 p-4 bg-slate-50 rounded-2xl outline-none font-bold text-xs text-slate-600 focus:bg-white focus:ring-2 ring-indigo-100 transition-all">
                        <option value="normal">æ¬Šé‡: ä¸€èˆ¬</option>
                        <option value="high">ğŸ”¥ æ¥µåº¦æƒ³è¦</option>
                        <option value="low">â˜• éš¨ç·£</option>
                    </select>
                </div>

                <select id="add-group-id" class="w-full p-4 bg-indigo-50/50 rounded-2xl outline-none font-bold text-sm text-indigo-600 focus:ring-2 ring-indigo-100 transition-all" onchange="loadGroupMembersForDebt(this.value)"></select>

                <div id="debt-options" class="hidden space-y-4 pt-2 animate-in fade-in slide-in-from-top-2">
                    <div class="flex gap-3">
                        <button type="button" onclick="setDebtDirection('owe_me')" id="dir-owe-me" class="flex-1 py-3 border-2 border-indigo-600 bg-indigo-50 text-indigo-700 rounded-xl text-xs font-bold transition-all relative overflow-hidden">åˆ¥äººæ¬ æˆ‘</button>
                        <button type="button" onclick="setDebtDirection('i_owe')" id="dir-i-owe" class="flex-1 py-3 border-2 border-slate-100 text-slate-400 rounded-xl text-xs font-bold transition-all">æˆ‘æ¬ åˆ¥äºº</button>
                    </div>
                    <select id="add-target-member" class="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold text-sm text-slate-700"></select>
                </div>

                <button type="button" onclick="handleSubmit(this)" class="w-full py-5 bg-slate-900 text-white font-bold rounded-2xl shadow-xl mt-4 btn-press transition-all hover:bg-black hover:shadow-2xl flex items-center justify-center gap-2">
                    <span>ç™¼ä½ˆç´€éŒ„</span>
                </button>
            </form>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://kzzxyyykpiquanxtfkwr.supabase.co'; 
        const supabaseKey = 'sb_publishable_K0ThQ9_ZqPPYk0sxxWgLhg_qwzuMNeG'; 
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let activeTab = 'dashboard';
        let currentAddType = 'wishlist';
        let debtDirection = 'owe_me'; 

        window.onload = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const inviteCode = urlParams.get('invite');
            if (inviteCode) localStorage.setItem('pending_invite', inviteCode);

            const { data: { session } } = await _supabase.auth.getSession();
            if (session) { 
                currentUser = session.user; 
                showApp();
                const pending = localStorage.getItem('pending_invite');
                if (pending) { joinGroupLogic(pending); localStorage.removeItem('pending_invite'); }
            } else {
                document.getElementById('login-screen').classList.remove('opacity-0');
            }
            lucide.createIcons();
            setupRealtime();
        };

        function setupRealtime() {
            _supabase.channel('public-db-changes')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'gifts' }, () => {
                if(activeTab === 'gifts') renderContent(); 
                showToast("è³‡æ–™å·²æ›´æ–°", 'info');
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'ledgers' }, () => {
                if(activeTab === 'ledgers' || activeTab === 'dashboard') renderContent();
                showToast("å¸³å‹™å·²æ›´æ–°", 'info');
            })
            .subscribe();
        }

        async function handleAuth(type, btn) {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            if (!email || !password) return showToast("è«‹è¼¸å…¥ Email èˆ‡å¯†ç¢¼", 'error');

            setLoading(btn, true);
            let res;
            if (type === 'login') res = await _supabase.auth.signInWithPassword({ email, password });
            else res = await _supabase.auth.signUp({ email, password });
            setLoading(btn, false);

            if (res.error) showToast(res.error.message, 'error');
            else if (type === 'signup') showToast("è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥ï¼", 'success');
            else { currentUser = res.data.user; showApp(); }
        }

        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            updateHeaderAvatar();
            switchTab('dashboard');
            loadGroupsToSelect();
        }

        async function renderContent() {
            const container = document.getElementById('content');
            
            if (activeTab === 'dashboard') {
                container.innerHTML = getSkeletonLoader();
                
                const [membersRes, ledgersRes] = await Promise.all([
                    _supabase.from('group_members').select('*, profiles(*)'),
                    _supabase.from('ledgers').select('*')
                ]);
                
                if (!membersRes.data || membersRes.data.length === 0) return renderEmpty('å°šç„¡å¥½å‹', 'å»è¨­å®šé é¢å»ºç«‹ç¾¤çµ„å§ï¼');

                let totalReceivable = 0;
                let totalPayable = 0;
                ledgersRes.data?.forEach(l => {
                    if (l.status === 'confirmed' || l.status === 'settling') {
                        if (l.creditor_id === currentUser.id) totalReceivable += l.amount;
                        if (l.debtor_id === currentUser.id) totalPayable += l.amount;
                    }
                });
                const netBalance = totalReceivable - totalPayable;

                const sortedBirthdays = membersRes.data
                    .filter(m => m.user_id !== currentUser.id)
                    .map(m => ({ ...m, days: calculateDays(m.profiles?.birthday) }))
                    .sort((a, b) => a.days - b.days);
                const nextBirthday = sortedBirthdays[0];

                container.innerHTML = `
                    <div class="flex overflow-x-auto snap-x-mandatory gap-4 pb-4 -mx-6 px-6 hide-scrollbar">
                        <div class="snap-center shrink-0 w-[85%] bg-gradient-to-br from-slate-900 to-slate-800 text-white p-6 rounded-[2rem] shadow-xl shadow-slate-200 relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-6 opacity-10"><i data-lucide="wallet" class="w-24 h-24"></i></div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Net Balance</p>
                            <h2 class="text-3xl font-black mb-6 tracking-tight ${netBalance >= 0 ? 'text-emerald-400' : 'text-rose-400'}">
                                ${netBalance >= 0 ? '+' : ''}$ ${netBalance.toLocaleString()}
                            </h2>
                            <div class="flex gap-4">
                                <div><p class="text-[10px] text-slate-400 font-bold uppercase">Receivable</p><p class="font-bold text-emerald-400 text-sm">+$${totalReceivable}</p></div>
                                <div><p class="text-[10px] text-slate-400 font-bold uppercase">Payable</p><p class="font-bold text-rose-400 text-sm">-$${totalPayable}</p></div>
                            </div>
                        </div>

                        ${nextBirthday ? `
                        <div class="snap-center shrink-0 w-[85%] bg-white border border-slate-100 p-6 rounded-[2rem] shadow-xl shadow-indigo-50 relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-6 opacity-5"><i data-lucide="cake" class="w-24 h-24 text-indigo-600"></i></div>
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 rounded-full bg-slate-100 overflow-hidden">
                                    <img src="${nextBirthday.profiles?.avatar_url || `https://api.dicebear.com/9.x/avataaars/svg?seed=${nextBirthday.profiles?.username}`}" class="w-full h-full object-cover">
                                </div>
                                <div>
                                    <p class="text-[10px] text-slate-400 font-bold uppercase">Next Birthday</p>
                                    <p class="font-bold text-slate-800 text-sm">${nextBirthday.nickname || nextBirthday.profiles?.username}</p>
                                </div>
                            </div>
                            <h2 class="text-4xl font-black text-indigo-600 mb-2">${nextBirthday.days}<span class="text-sm text-slate-400 ml-1 font-bold">DAYS LEFT</span></h2>
                            <button onclick="syncCalendar('${nextBirthday.nickname}', '${nextBirthday.profiles?.birthday}')" class="text-[10px] font-bold bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-full mt-2 inline-flex items-center gap-1">
                                <i data-lucide="calendar-plus" class="w-3 h-3"></i> Sync Calendar
                            </button>
                        </div>` : ''}
                    </div>

                    <div class="flex items-center justify-between mb-4 mt-2">
                        <h3 class="text-sm font-black text-slate-900 uppercase tracking-wider">All Friends</h3>
                    </div>
                    <div class="space-y-3">
                        ${sortedBirthdays.map(m => `
                            <div class="bg-white p-4 rounded-[1.5rem] shadow-sm border border-slate-100 flex justify-between items-center group active:scale-[0.98] transition-transform duration-200">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-slate-100 overflow-hidden">
                                        <img src="${m.profiles?.avatar_url || `https://api.dicebear.com/9.x/avataaars/svg?seed=${m.profiles?.username}`}" class="w-full h-full object-cover">
                                    </div>
                                    <p class="font-bold text-sm text-slate-800">${m.nickname || m.profiles?.username}</p>
                                </div>
                                <span class="font-black text-slate-300 text-sm">${m.days}d</span>
                            </div>
                        `).join('')}
                    </div>`;

            } else if (activeTab === 'gifts') {
                container.innerHTML = getSkeletonLoader();
                const { data: gifts } = await _supabase.from('gifts').select('*').order('created_at', { ascending: false });
                if (!gifts || gifts.length === 0) return renderEmpty('é¡˜æœ›æ¸…å–®æ˜¯ç©ºçš„', 'æ–°å¢ä¸€å€‹é¡˜æœ›ï¼Œè®“æœ‹å‹çµ¦ä½ é©šå–œï¼');

                container.innerHTML = `
                    <div class="grid grid-cols-1 gap-4">
                        ${gifts.map(g => {
                            const isMine = g.creator_id === currentUser.id;
                            const isReservedByMe = g.reserved_by === currentUser.id;
                            
                            return `
                            <div class="bg-white p-5 rounded-[1.8rem] border border-slate-100 shadow-sm flex justify-between items-center ${g.priority === 'high' ? 'priority-high shadow-indigo-100' : ''}">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <p class="font-bold text-slate-800 text-sm">${g.item_name}</p>
                                        ${g.priority === 'high' ? '<span class="text-[8px] bg-rose-50 text-rose-500 px-2 py-0.5 rounded-full font-black tracking-wider">HOT</span>' : ''}
                                    </div>
                                    <p class="text-xs font-bold text-slate-400">$ ${g.amount.toLocaleString()}</p>
                                </div>
                                <div>
                                    ${isMine ? 
                                        `<span class="text-[10px] font-bold text-slate-300 bg-slate-50 px-3 py-1.5 rounded-full">${g.is_reserved ? 'å·²è¢«èªé ˜ ğŸ¤«' : 'ç­‰å¾…é©šå–œ'}</span>` : 
                                        (g.is_reserved ? 
                                            (isReservedByMe ? 
                                                `<span class="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-3 py-1.5 rounded-full flex items-center gap-1"><i data-lucide="check" class="w-3 h-3"></i> ä½ å·²èªé ˜</span>` :
                                                `<span class="text-[10px] font-bold text-slate-400 bg-slate-50 px-3 py-1.5 rounded-full">å·²è¢«èªé ˜</span>`
                                            ) : 
                                            `<button onclick="reserveGift('${g.id}', this)" class="text-[10px] font-bold bg-slate-900 text-white px-5 py-2.5 rounded-full shadow-lg shadow-slate-200 active:scale-90 transition-transform hover:bg-indigo-600">èªé ˜</button>`
                                        )
                                    }
                                </div>
                            </div>`;
                        }).join('')}
                    </div>`;

            } else if (activeTab === 'ledgers') {
                container.innerHTML = getSkeletonLoader();
                const { data: ledgers } = await _supabase.from('ledgers').select('*, creditor:profiles!creditor_id(username), debtor:profiles!debtor_id(username)').order('created_at', { ascending: false });
                if (!ledgers || ledgers.length === 0) return renderEmpty('æ²’æœ‰å¸³å‹™', 'å¥½æœ‹å‹æ˜ç®—å¸³ï¼Œç´€éŒ„ç¬¬ä¸€ç­†å§ï¼');

                container.innerHTML = `
                    <div class="space-y-3">
                        ${ledgers.map(l => {
                            const isMeCreditor = l.creditor_id === currentUser.id;
                            const otherName = isMeCreditor ? (l.debtor?.username || 'å°æ–¹') : (l.creditor?.username || 'å°æ–¹');
                            
                            let actionBtn = '';
                            let statusBadge = '';
                            
                            if (l.status === 'pending') {
                                statusBadge = `<span class="w-2 h-2 bg-amber-400 rounded-full animate-pulse"></span>`;
                                if (!isMeCreditor) actionBtn = `<button onclick="updateLedger('${l.id}', 'confirmed', this)" class="btn-xs bg-emerald-500 text-white shadow-emerald-200">ç¢ºèª</button>`;
                                else actionBtn = `<span class="badge text-amber-500 bg-amber-50">å¾…ç¢ºèª</span>`;
                            } else if (l.status === 'confirmed') {
                                if (!isMeCreditor) actionBtn = `<button onclick="updateLedger('${l.id}', 'settling', this)" class="btn-xs bg-indigo-500 text-white shadow-indigo-200">é‚„æ¬¾</button>`;
                                else actionBtn = `<span class="badge text-emerald-600 bg-emerald-50">å·²ç¢ºèª</span>`;
                            } else if (l.status === 'settling') {
                                if (isMeCreditor) actionBtn = `<button onclick="updateLedger('${l.id}', 'settled', this)" class="btn-xs bg-indigo-600 text-white shadow-slate-200">ç¢ºèªæ”¶æ¬¾</button>`;
                                else actionBtn = `<span class="badge text-indigo-500 bg-indigo-50">é‚„æ¬¾ä¸­</span>`;
                            } else {
                                actionBtn = `<span class="badge text-slate-300 bg-slate-50 line-through decoration-2">å·²çµæ¸…</span>`;
                            }

                            return `
                            <div class="bg-white p-5 rounded-[1.5rem] border ${l.status==='settled' ? 'border-slate-50 opacity-50' : 'border-slate-200'} flex justify-between items-center shadow-sm">
                                <div class="flex items-center gap-3">
                                    <div class="p-3 rounded-full ${isMeCreditor ? 'bg-emerald-50 text-emerald-500' : 'bg-rose-50 text-rose-500'}">
                                        <i data-lucide="${isMeCreditor ? 'arrow-down-left' : 'arrow-up-right'}" class="w-4 h-4"></i>
                                    </div>
                                    <div>
                                        <div class="flex items-center gap-2 mb-0.5">
                                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">${l.description || 'å¸³å‹™'}</p>
                                            ${statusBadge}
                                        </div>
                                        <p class="font-bold text-sm flex items-center gap-1">
                                            <span class="text-slate-700">${otherName}</span>
                                            <span class="text-slate-900 ml-1 font-black">$${l.amount}</span>
                                        </p>
                                    </div>
                                </div>
                                <div>${actionBtn}</div>
                            </div>`
                        }).join('')}
                    </div>`;
            } else if (activeTab === 'settings') {
                 renderSettingsPage(container);
            }
            lucide.createIcons();
        }

        async function reserveGift(id, btn) {
            triggerHaptic();
            setLoading(btn, true);
            const { error } = await _supabase.from('gifts').update({ is_reserved: true, reserved_by: currentUser.id }).eq('id', id);
            if (!error) { 
                triggerConfetti();
                showToast("èªé ˜æˆåŠŸï¼æº–å‚™é©šå–œå§ ğŸ‰", 'success'); 
                renderContent(); 
            } else {
                setLoading(btn, false);
                showToast("æ“ä½œå¤±æ•—", 'error');
            }
        }

        async function updateLedger(id, status, btn) {
            triggerHaptic();
            if (btn) setLoading(btn, true);
            const { error } = await _supabase.from('ledgers').update({ status }).eq('id', id);
            if (!error) { 
                if (status === 'settled') triggerConfetti();
                showToast("ç‹€æ…‹å·²æ›´æ–°", 'success'); 
                renderContent(); 
            } else showToast("æ›´æ–°å¤±æ•—", 'error');
        }

        async function handleSubmit(btn) {
            triggerHaptic();
            const name = document.getElementById('add-name').value;
            const amount = document.getElementById('add-amount').value;
            const groupId = document.getElementById('add-group-id').value;
            
            if (!name || !groupId) return showToast("è³‡è¨Šä¸å®Œæ•´", 'error');

            setLoading(btn, true); 

            let error;
            if (currentAddType === 'wishlist') {
                const priority = document.getElementById('add-priority').value;
                const res = await _supabase.from('gifts').insert([{ item_name: name, amount: parseInt(amount)||0, group_id: groupId, priority, creator_id: currentUser.id }]);
                error = res.error;
            } else {
                const targetId = document.getElementById('add-target-member').value;
                if (!targetId) { setLoading(btn, false); return showToast("è«‹é¸æ“‡å°è±¡", 'error'); }
                let creditor = debtDirection === 'owe_me' ? currentUser.id : targetId;
                let debtor = debtDirection === 'owe_me' ? targetId : currentUser.id;
                const res = await _supabase.from('ledgers').insert([{ description: name, amount: parseInt(amount)||0, group_id: groupId, creditor_id: creditor, debtor_id: debtor }]);
                error = res.error;
            }

            setLoading(btn, false);

            if (!error) { 
                showToast("ç™¼ä½ˆæˆåŠŸ", 'success'); 
                closeModal(); 
                document.getElementById('add-name').value = '';
                document.getElementById('add-amount').value = '';
                renderContent(); 
            } else showToast(error.message, 'error');
        }

        function setLoading(btn, isLoading) {
            if (isLoading) {
                btn.dataset.originalText = btn.innerHTML;
                btn.innerHTML = '<div class="spinner mx-auto"></div>';
                btn.disabled = true;
                btn.classList.add('opacity-70');
            } else {
                btn.innerHTML = btn.dataset.originalText || btn.innerHTML;
                btn.disabled = false;
                btn.classList.remove('opacity-70');
            }
        }

        function triggerConfetti() { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#4f46e5', '#10b981', '#fb7185'] }); }
        function triggerHaptic() { if (navigator.vibrate) navigator.vibrate(10); }
        function getSkeletonLoader() { return `<div class="space-y-4 animate-pulse"><div class="h-32 bg-slate-100 rounded-[2rem]"></div><div class="h-20 bg-slate-100 rounded-[1.5rem]"></div><div class="h-20 bg-slate-100 rounded-[1.5rem]"></div></div>`; }
        function showToast(msg, type='info') {
            const t = document.getElementById('toast');
            const icon = type === 'success' ? 'check-circle' : (type === 'error' ? 'alert-circle' : 'info');
            const color = type === 'success' ? 'text-emerald-400' : (type === 'error' ? 'text-rose-400' : 'text-blue-400');
            t.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4 ${color}"></i><span>${msg}</span>`;
            t.classList.add('show');
            lucide.createIcons();
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        async function renderSettingsPage(container) {
            const { data: profile } = await _supabase.from('profiles').select('*').eq('id', currentUser.id).single();
            const { data: myGroups } = await _supabase.from('groups').select('*');
            const avatarUrl = profile?.avatar_url || `https://api.dicebear.com/9.x/avataaars/svg?seed=${profile?.username || currentUser.email}`;

            container.innerHTML = `
                <div class="flex flex-col items-center mb-8 pt-4">
                    <div class="relative mb-4 group cursor-pointer" onclick="promptAvatar()">
                        <div class="w-24 h-24 rounded-full bg-slate-100 p-1 shadow-lg border border-slate-100 overflow-hidden relative">
                            <img src="${avatarUrl}" class="w-full h-full rounded-full object-cover bg-white">
                            <div class="absolute inset-0 bg-black/30 hidden group-hover:flex items-center justify-center rounded-full text-white text-xs font-bold">æ›´æ›</div>
                        </div>
                    </div>
                    <h2 class="text-xl font-black text-slate-900">${profile?.username || 'æœªè¨­å®šæš±ç¨±'}</h2>
                    <p class="text-xs font-bold text-slate-400 mb-4">${currentUser.email}</p>
                    <button onclick="openEditProfile('${profile?.username||''}', '${profile?.birthday||''}')" class="px-5 py-2 bg-slate-900 text-white text-xs font-bold rounded-full shadow-lg active:scale-95 transition-transform">ç·¨è¼¯è³‡æ–™</button>
                </div>
                <div class="mb-6">
                    <h3 class="px-4 text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">My Groups</h3>
                    <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden">
                        ${myGroups && myGroups.length > 0 ? myGroups.map(g => `
                            <div class="flex justify-between items-center p-4 border-b border-slate-50 last:border-0">
                                <span class="font-bold text-sm text-slate-700">${g.name}</span>
                                <button onclick="shareInvite('${g.invite_code}')" class="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded">é‚€è«‹</button>
                            </div>
                        `).join('') : '<div class="p-4 text-center text-xs text-slate-300">ç„¡ç¾¤çµ„</div>'}
                        <div class="p-2 flex gap-2 bg-slate-50/50">
                            <button onclick="openGroupModal('create')" class="flex-1 py-3 bg-white rounded-xl text-xs font-bold text-indigo-600 shadow-sm">å»ºç«‹</button>
                            <button onclick="openGroupModal('join')" class="flex-1 py-3 bg-white rounded-xl text-xs font-bold text-slate-600 shadow-sm">åŠ å…¥</button>
                        </div>
                    </div>
                </div>
                <button onclick="handleLogout()" class="w-full py-4 text-rose-500 font-bold text-xs bg-white rounded-2xl shadow-sm border border-slate-100">ç™»å‡ºå¸³è™Ÿ</button>
            `;
        }
        
        function renderEmpty(t, d) { return `<div class="flex flex-col items-center justify-center h-full opacity-40 mt-10"><i data-lucide="ghost" class="w-12 h-12 mb-4"></i><h3 class="text-lg font-black">${t}</h3><p class="text-xs font-bold">${d}</p></div>`; }
        function calculateDays(d) { if(!d)return 999; const t=new Date(),b=new Date(d); b.setFullYear(t.getFullYear()); if(b<t)b.setFullYear(t.getFullYear()+1); return Math.ceil((b-t)/864e5); }
        function syncCalendar(n,b){ if(!b)return showToast("ç„¡ç”Ÿæ—¥", 'error'); const t=new Date(),[y,m,d]=b.split('-'); let ny=t.getFullYear(); if(new Date(ny,m-1,d)<t)ny++; const ds=`${ny}${m}${d}`; window.open(`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${n}ç”Ÿæ—¥&dates=${ds}/${ds}`,'_blank'); }
        function switchTab(t) { activeTab = t; document.querySelectorAll('.nav-btn').forEach(b=>b.classList.add('opacity-40')); document.getElementById('nav-'+t).classList.remove('opacity-40'); renderContent(); }
        function openAddModal(){document.getElementById('add-modal').classList.remove('hidden');}
        function closeModal(){document.getElementById('add-modal').classList.add('hidden');}
        async function handleLogout(){await _supabase.auth.signOut();window.location.reload();}
        async function updateHeaderAvatar(){const{data:p}=await _supabase.from('profiles').select('avatar_url,username').eq('id',currentUser.id).single(); const url=p?.avatar_url||`https://api.dicebear.com/9.x/avataaars/svg?seed=${p?.username||currentUser.email}`; document.getElementById('header-avatar').innerHTML=`<img src="${url}" class="w-full h-full object-cover">`;}
        
        async function openEditProfile(oldName, oldBday) {
            const newName = prompt("è«‹è¼¸å…¥æ–°çš„æš±ç¨±ï¼š", oldName); if (newName === null) return;
            const newBday = prompt("è«‹è¼¸å…¥ç”Ÿæ—¥ (YYYY-MM-DD)ï¼š", oldBday); if (newBday === null) return;
            const { error } = await _supabase.from('profiles').update({ username: newName, birthday: newBday }).eq('id', currentUser.id);
            if (!error) { showToast("è³‡æ–™å·²æ›´æ–°ï¼", 'success'); renderContent(); updateHeaderAvatar(); } else showToast(error.message, 'error');
        }
        async function promptAvatar() {
            const url = prompt("è«‹è¼¸å…¥åœ–ç‰‡é€£çµ (JPG/PNG)ï¼š"); if (url === null) return;
            const updateVal = url.trim() === "" ? null : url;
            const { error } = await _supabase.from('profiles').update({ avatar_url: updateVal }).eq('id', currentUser.id);
            if (!error) { showToast("é ­åƒå·²æ›´æ–°", 'success'); renderContent(); updateHeaderAvatar(); } else showToast(error.message, 'error');
        }
        function openGroupModal(action) {
            if (action === 'create') { const name = prompt("è«‹è¼¸å…¥æ–°ç¾¤çµ„åç¨±ï¼š"); if (name) createGroupLogic(name); } 
            else { const code = prompt("è«‹è¼¸å…¥ 6 ç¢¼é‚€è«‹ç¢¼ï¼š"); if (code) joinGroupLogic(code); }
        }
        async function createGroupLogic(name) {
            const { data: group, error } = await _supabase.from('groups').insert([{ name, creator_id: currentUser.id }]).select().single();
            if (!error) { await _supabase.from('group_members').insert([{ group_id: group.id, user_id: currentUser.id, role: 'admin' }]); showToast("å»ºç«‹æˆåŠŸ", 'success'); renderContent(); loadGroupsToSelect(); } else showToast(error.message, 'error');
        }
        async function joinGroupLogic(code) {
            const { data: group } = await _supabase.from('groups').select('id').eq('invite_code', code).single();
            if (!group) return showToast("é‚€è«‹ç¢¼ç„¡æ•ˆ", 'error');
            const { error } = await _supabase.from('group_members').insert([{ group_id: group.id, user_id: currentUser.id }]);
            if (!error) { showToast("æˆåŠŸåŠ å…¥", 'success'); renderContent(); loadGroupsToSelect(); } else showToast("ä½ å·²ç¶“åœ¨è©²ç¾¤çµ„äº†", 'info');
        }
        function shareInvite(code) { const url = `${window.location.origin}${window.location.pathname}?invite=${code}`; if(navigator.share) navigator.share({title:'Join my GiftFlow Group', url}); else { navigator.clipboard.writeText(url); showToast("é€£çµå·²è¤‡è£½", 'success'); } }
        async function loadGroupsToSelect(){const{data}=await _supabase.from('groups').select('*'); const s=document.getElementById('add-group-id'); if(s){s.innerHTML='<option value="">é¸æ“‡ç¾¤çµ„</option>';data?.forEach(g=>s.innerHTML+=`<option value="${g.id}">${g.name}</option>`)}}
        async function loadGroupMembersForDebt(gid){
            if(currentAddType!=='debt'||!gid)return;
            const{data:ms}=await _supabase.from('group_members').select('user_id,profiles(username)').eq('group_id',gid);
            const s=document.getElementById('add-target-member'); s.innerHTML='';
            ms?.filter(m=>m.user_id!==currentUser.id).forEach(m=>s.innerHTML+=`<option value="${m.user_id}">${m.profiles?.username||'User'}</option>`);
        }
        function setAddType(t) {
            currentAddType = t;
            const isW = t === 'wishlist';
            document.getElementById('type-wish').className = isW ? 'flex-1 py-3.5 rounded-xl text-xs font-black bg-white shadow-sm text-indigo-600 transition-all' : 'flex-1 py-3.5 rounded-xl text-xs font-black text-slate-400 transition-all';
            document.getElementById('type-debt').className = !isW ? 'flex-1 py-3.5 rounded-xl text-xs font-black bg-white shadow-sm text-indigo-600 transition-all' : 'flex-1 py-3.5 rounded-xl text-xs font-black text-slate-400 transition-all';
            document.getElementById('add-priority').parentElement.classList.toggle('hidden', !isW);
            document.getElementById('debt-options').classList.toggle('hidden', isW);
            if(!isW) loadGroupMembersForDebt(document.getElementById('add-group-id').value);
        }
        function setDebtDirection(d){
            debtDirection=d;
            document.getElementById('dir-owe-me').className = d==='owe_me'?'flex-1 py-3 border-2 border-indigo-600 bg-indigo-50 text-indigo-700 rounded-xl text-xs font-bold transition-all relative overflow-hidden':'flex-1 py-3 border-2 border-slate-100 text-slate-400 rounded-xl text-xs font-bold transition-all';
            document.getElementById('dir-i-owe').className = d!=='owe_me'?'flex-1 py-3 border-2 border-slate-100 bg-rose-50 text-rose-600 rounded-xl text-xs font-bold transition-all':'flex-1 py-3 border-2 border-slate-100 text-slate-400 rounded-xl text-xs font-bold transition-all';
        }

        document.querySelectorAll('.btn-xs').forEach(btn => btn.className += " px-3 py-1.5 rounded-full shadow-sm text-[10px] font-bold");
        document.querySelectorAll('.badge').forEach(badge => badge.className += " px-2 py-1 rounded-full text-[10px] font-bold");
    </script>
</body>
</html>
