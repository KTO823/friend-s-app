<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <title>GIFTFLOW</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #F8FAFC; }
        
        /* ç»ç’ƒæ“¬æ…‹èˆ‡å®‰å…¨å€ */
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-top: 1px solid rgba(0,0,0,0.05); }
        .safe-bottom { padding-bottom: calc(env(safe-area-inset-bottom) + 20px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }

        /* å½ˆçª—çµ•å°ç½®ä¸­è¨­å®š */
        .modal-overlay { position: fixed; inset: 0; z-index: 60; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; padding: 20px; transition: opacity 0.2s; opacity: 0; pointer-events: none; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; width: 100%; max-width: 360px; border-radius: 40px; padding: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); transform: scale(0.95); transition: transform 0.2s; }
        .modal-overlay.open .modal-content { transform: scale(1); }

        /* è¼¸å…¥æ¡†å„ªåŒ– (é˜²æ­¢ iOS æ”¾å¤§) */
        input, select { font-size: 16px !important; }
        .input-box { width: 100%; padding: 16px; background-color: #F1F5F9; border-radius: 20px; border: 2px solid transparent; outline: none; font-weight: bold; color: #334155; transition: all 0.2s; }
        .input-box:focus { background-color: white; border-color: #6366F1; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-primary { width: 100%; padding: 18px; background-color: #4F46E5; color: white; font-weight: 900; border-radius: 24px; box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.4); transition: transform 0.1s; }
        .btn-primary:active { transform: scale(0.96); }
        .btn-secondary { width: 100%; padding: 18px; background-color: white; color: #4F46E5; font-weight: 900; border-radius: 24px; border: 2px solid #F1F5F9; transition: transform 0.1s; }
        .btn-secondary:active { transform: scale(0.96); }

        /* åº•éƒ¨å°èˆªé¸ä¸­æ…‹ */
        .nav-btn { opacity: 0.4; transition: opacity 0.2s; }
        .nav-btn.active { opacity: 1; color: #4F46E5; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div id="login-screen" class="fixed inset-0 z-50 bg-[#F8FAFC] flex flex-col items-center justify-center p-6 transition-opacity duration-300">
        <div class="w-full max-w-sm bg-white rounded-[40px] shadow-2xl p-10 text-center">
            <div class="inline-block p-5 bg-indigo-50 rounded-3xl text-indigo-600 mb-8">
                <i data-lucide="gift" class="w-12 h-12"></i>
            </div>
            <h1 class="text-2xl font-black text-slate-800 mb-2">ç¥å¥‡å¥½å‹ç¦®ç‰© App</h1>
            <p class="text-sm text-slate-400 mb-10 font-bold">è¼¸å…¥ Email å³å¯ç™»å…¥æˆ–è‡ªå‹•è¨»å†Š</p>
            <form id="auth-form" class="space-y-4">
                <input type="email" id="email" placeholder="Email" class="input-box">
                <input type="password" id="password" placeholder="Password" class="input-box">
                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="handleAuth('login')" class="btn-primary">ç™»å…¥</button>
                    <button type="button" onclick="handleAuth('signup')" class="btn-secondary">è¨»å†Š</button>
                </div>
            </form>
        </div>
    </div>

    <div id="main-app" class="hidden flex-1 flex flex-col h-full">
        <header class="px-6 py-5 bg-[#F8FAFC] flex justify-between items-center sticky top-0 z-10">
            <h1 class="text-xl font-black italic text-slate-900 tracking-tighter">GIFT<span class="text-indigo-600">FLOW</span></h1>
            <button onclick="handleLogout()" class="text-xs font-bold text-slate-400 bg-white px-3 py-1.5 rounded-full shadow-sm">ç™»å‡º</button>
        </header>

        <main id="content" class="flex-1 overflow-y-auto px-6 pb-32 hide-scrollbar space-y-6">
            </main>

        <nav class="glass fixed bottom-0 w-full z-20 px-8 pt-4 safe-bottom flex justify-between items-end">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-btn flex flex-col items-center gap-1 active"><i data-lucide="layout-grid" class="w-6 h-6"></i><span class="text-[10px] font-bold">ç¸½è¦½</span></button>
            <button onclick="switchTab('gifts')" id="nav-gifts" class="nav-btn flex flex-col items-center gap-1"><i data-lucide="gift" class="w-6 h-6"></i><span class="text-[10px] font-bold">ç¦®ç‰©</span></button>
            
            <div class="relative -top-8">
                <button onclick="openAddModal()" class="w-16 h-16 bg-indigo-600 rounded-full shadow-xl shadow-indigo-300 flex items-center justify-center text-white border-4 border-[#F8FAFC] active:scale-95 transition-transform">
                    <i data-lucide="plus" class="w-8 h-8"></i>
                </button>
            </div>

            <button onclick="switchTab('ledgers')" id="nav-ledgers" class="nav-btn flex flex-col items-center gap-1"><i data-lucide="credit-card" class="w-6 h-6"></i><span class="text-[10px] font-bold">å¸³å‹™</span></button>
            <button onclick="switchTab('settings')" id="nav-settings" class="nav-btn flex flex-col items-center gap-1"><i data-lucide="user" class="w-6 h-6"></i><span class="text-[10px] font-bold">æˆ‘çš„</span></button>
        </nav>
    </div>

    <div id="add-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black text-slate-800">æ–°å¢é …ç›®</h2>
                <button onclick="closeModal()" class="p-2 bg-slate-100 rounded-full text-slate-500"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="flex bg-slate-100 p-1.5 rounded-2xl mb-6">
                <button onclick="setAddType('wishlist')" id="type-wish" class="flex-1 py-3 rounded-xl text-xs font-bold bg-white text-indigo-600 shadow-sm transition-all">ğŸ é¡˜æœ›</button>
                <button onclick="setAddType('debt')" id="type-debt" class="flex-1 py-3 rounded-xl text-xs font-bold text-slate-400 transition-all">ğŸ’¸ è¨˜å¸³</button>
            </div>

            <div class="space-y-4">
                <input type="text" id="add-name" placeholder="åç¨± (ä¾‹å¦‚: AirPods)" class="input-box">
                <div class="flex gap-3">
                    <input type="number" id="add-amount" placeholder="é‡‘é¡" class="input-box">
                    <select id="add-group-id" class="input-box text-indigo-600 bg-indigo-50 border-indigo-100" style="width: 140px;"></select>
                </div>
                
                <div id="debt-options" class="hidden">
                    <p class="text-xs font-bold text-slate-400 mb-2 ml-2">å€Ÿè²¸å°è±¡</p>
                    <select id="add-target-member" class="input-box"></select>
                </div>

                <button onclick="handleSubmit()" class="btn-primary mt-2">ç™¼ä½ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // è¨­å®š Supabase
        const supabaseUrl = 'https://kzzxyyykpiquanxtfkwr.supabase.co'; 
        const supabaseKey = 'sb_publishable_K0ThQ9_ZqPPYk0sxxWgLhg_qwzuMNeG'; 
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let activeTab = 'dashboard';
        let currentAddType = 'wishlist';

        // 1. åˆå§‹åŒ–
        window.onload = async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) { 
                currentUser = session.user; 
                showApp(); 
            }
            lucide.createIcons();
        };

        // 2. ç™»å…¥/è¨»å†Š
        async function handleAuth(type) {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            if (!email || !password) return alert("è«‹è¼¸å…¥ Email èˆ‡å¯†ç¢¼");

            let res;
            if (type === 'login') res = await _supabase.auth.signInWithPassword({ email, password });
            else res = await _supabase.auth.signUp({ email, password });

            if (res.error) alert(res.error.message);
            else { 
                if(type==='signup') alert("è¨»å†ŠæˆåŠŸï¼Œå·²è‡ªå‹•ç™»å…¥");
                currentUser = res.data.user; 
                showApp(); 
            }
        }

        function showApp() {
            document.getElementById('login-screen').classList.add('opacity-0', 'pointer-events-none');
            document.getElementById('main-app').classList.remove('hidden');
            renderContent();
            loadGroupsToSelect();
        }

        // 3. é é¢æ¸²æŸ“ (ä¿ç•™æ‚¨å–œæ­¡çš„é¢¨æ ¼)
        async function renderContent() {
            const container = document.getElementById('content');
            // æ¸…ç©ºå…§å®¹ï¼Œé¿å…é–ƒçˆç‰¹æ•ˆï¼Œæ”¹ç‚ºç°¡å–®çš„æ–‡å­—
            container.innerHTML = '';

            if (activeTab === 'dashboard') {
                // è®€å–è³‡æ–™
                const { data: profile } = await _supabase.from('profiles').select('*').eq('id', currentUser.id).single();
                
                // ç´«è‰²å¡ç‰‡ (é‚„åŸæ‚¨å–œæ­¡çš„è¨­è¨ˆ)
                container.innerHTML = `
                    <div class="bg-[#4F46E5] p-8 rounded-[40px] text-white shadow-xl shadow-indigo-200 mb-6">
                        <p class="text-[10px] font-black tracking-widest uppercase opacity-60 mb-1">WELCOME BACK</p>
                        <h2 class="text-2xl font-black">${profile?.username || currentUser.email.split('@')[0]}</h2>
                        <p class="text-xs font-bold opacity-80 mt-2">${currentUser.email}</p>
                    </div>
                    
                    <div class="bg-white p-8 rounded-[40px] shadow-sm border border-slate-100 text-center">
                        <div class="w-12 h-12 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-4 text-green-500">
                            <i data-lucide="cloud" class="w-6 h-6"></i>
                        </div>
                        <p class="text-slate-800 font-black text-lg">é›²ç«¯é€£ç·šæ­£å¸¸</p>
                        <p class="text-xs text-slate-400 font-bold mt-2">è³‡æ–™å·²åŒæ­¥è‡³æœ€æ–°ç‹€æ…‹</p>
                    </div>
                `;

            } else if (activeTab === 'gifts') {
                const { data } = await _supabase.from('gifts').select('*').order('created_at', { ascending: false });
                
                let html = `<h2 class="text-2xl font-black mb-6 pl-2">ç¦®ç‰©æ¸…å–®</h2>`;
                if (!data || data.length === 0) {
                    html += `<div class="text-center py-20 opacity-30 font-bold text-slate-400">ç›®å‰æ²’æœ‰ç¦®ç‰©ï¼Œé»æ“Šï¼‹æ–°å¢ä¸€å€‹å§ï¼</div>`;
                } else {
                    html += `<div class="space-y-4">`;
                    data.forEach(g => {
                        html += `
                        <div class="bg-white p-6 rounded-[30px] border border-slate-100 shadow-sm flex justify-between items-center">
                            <div>
                                <p class="font-black text-slate-800 text-lg">${g.item_name}</p>
                                <p class="text-xs font-bold text-slate-400 mt-1">$${g.amount}</p>
                            </div>
                            <span class="bg-slate-100 text-slate-500 px-4 py-2 rounded-xl text-xs font-bold">
                                ${g.is_reserved ? 'å·²è¢«èªé ˜' : 'ç­‰å¾…ä¸­'}
                            </span>
                        </div>`;
                    });
                    html += `</div>`;
                }
                container.innerHTML = html;

            } else if (activeTab === 'ledgers') {
                const { data } = await _supabase.from('ledgers').select('*, creditor:profiles!creditor_id(username), debtor:profiles!debtor_id(username)');
                
                let html = `<h2 class="text-2xl font-black mb-6 pl-2">å¸³å‹™ç´€éŒ„</h2>`;
                if (!data || data.length === 0) {
                    html += `<div class="text-center py-20 opacity-30 font-bold text-slate-400">æ²’æœ‰æ¬ å‚µç´€éŒ„ï¼Œå¤ªæ£’äº†ï¼</div>`;
                } else {
                    html += `<div class="space-y-4">`;
                    data.forEach(l => {
                        const isMeCred = l.creditor_id === currentUser.id;
                        html += `
                        <div class="bg-white p-6 rounded-[30px] border border-slate-100 shadow-sm flex justify-between items-center">
                            <div class="flex items-center gap-4">
                                <div class="p-3 rounded-full ${isMeCred ? 'bg-green-50 text-green-500' : 'bg-rose-50 text-rose-500'}">
                                    <i data-lucide="${isMeCred ? 'arrow-down-left' : 'arrow-up-right'}" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <p class="text-xs font-bold text-slate-400 mb-1">${l.description}</p>
                                    <p class="font-black text-slate-800">$${l.amount}</p>
                                </div>
                            </div>
                            <span class="text-xs font-bold text-slate-400">${l.status}</span>
                        </div>`;
                    });
                    html += `</div>`;
                }
                container.innerHTML = html;

            } else if (activeTab === 'settings') {
                const { data: p } = await _supabase.from('profiles').select('*').eq('id', currentUser.id).single();
                const { data: g } = await _supabase.from('groups').select('*');

                container.innerHTML = `
                    <div class="text-center mb-8 pt-4">
                        <div class="w-20 h-20 bg-slate-200 rounded-full mx-auto mb-4 overflow-hidden border-4 border-white shadow-lg">
                            <img src="${p?.avatar_url || `https://api.dicebear.com/9.x/avataaars/svg?seed=${currentUser.email}`}" class="w-full h-full object-cover">
                        </div>
                        <h2 class="text-2xl font-black text-slate-800">${p?.username || 'User'}</h2>
                        <button onclick="updateProfile()" class="text-xs font-bold text-indigo-500 mt-2">ç·¨è¼¯åç¨± / éŠ€è¡Œå¸³è™Ÿ</button>
                    </div>

                    <div class="bg-white p-6 rounded-[40px] shadow-sm border border-slate-100 mb-6">
                        <h3 class="text-xs font-black text-slate-300 uppercase mb-4 pl-2">My Groups</h3>
                        <div class="space-y-3 mb-4">
                            ${g?.length ? g.map(gp => `<div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl"><span class="font-bold text-slate-700">${gp.name}</span><span class="text-xs font-bold text-slate-400">${gp.invite_code}</span></div>`).join('') : '<p class="text-center text-xs text-slate-300">å°šæœªåŠ å…¥ç¾¤çµ„</p>'}
                        </div>
                        <div class="flex gap-3">
                            <button onclick="handleCreateGroup()" class="flex-1 py-3 bg-slate-100 rounded-xl text-xs font-bold text-slate-600">å»ºç«‹ç¾¤çµ„</button>
                            <button onclick="handleJoinGroup()" class="flex-1 py-3 bg-slate-100 rounded-xl text-xs font-bold text-slate-600">åŠ å…¥ç¾¤çµ„</button>
                        </div>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        // 4. åŠŸèƒ½é‚è¼¯ (ä¿®æ­£ç¾¤çµ„å»ºç«‹)
        async function handleCreateGroup() {
            const name = prompt("è«‹è¼¸å…¥ç¾¤çµ„åç¨±ï¼š");
            if (!name) return;

            // 1. å»ºç«‹ç¾¤çµ„ (SQLå·²ä¿®æ­£æ¬Šé™ï¼Œç¾åœ¨å¯ä»¥äº†)
            const { data: g, error } = await _supabase.from('groups').insert([{ name, creator_id: currentUser.id }]).select().single();
            
            if (error) return alert("å»ºç«‹å¤±æ•—: " + error.message);

            // 2. åŠ å…¥è‡ªå·±
            await _supabase.from('group_members').insert([{ group_id: g.id, user_id: currentUser.id, role: 'admin' }]);
            
            alert("ç¾¤çµ„å»ºç«‹æˆåŠŸï¼");
            renderContent();
            loadGroupsToSelect();
        }

        async function handleJoinGroup() {
            const code = prompt("è«‹è¼¸å…¥é‚€è«‹ç¢¼ï¼š");
            if(!code) return;
            // ç°¡å–®åŠ å…¥é‚è¼¯
            const { data: g } = await _supabase.from('groups').select('id').eq('invite_code', code).single();
            if(!g) return alert("é‚€è«‹ç¢¼ç„¡æ•ˆ");
            const { error } = await _supabase.from('group_members').insert([{ group_id: g.id, user_id: currentUser.id }]);
            if(error) alert("åŠ å…¥å¤±æ•—æˆ–å·²åœ¨ç¾¤çµ„ä¸­"); else { alert("åŠ å…¥æˆåŠŸ"); renderContent(); loadGroupsToSelect(); }
        }

        async function updateProfile() {
            const name = prompt("è«‹è¼¸å…¥æ–°çš„æš±ç¨±ï¼š");
            if(!name) return;
            // é€™è£¡ä¸æœƒå†å ±éŒ¯ï¼Œå› ç‚º SQL å·²ç¶“è£œä¸Šæ¬„ä½äº†
            await _supabase.from('profiles').update({ username: name }).eq('id', currentUser.id);
            renderContent();
        }

        async function handleSubmit() {
            const name = document.getElementById('add-name').value;
            const amount = document.getElementById('add-amount').value;
            const gid = document.getElementById('add-group-id').value;
            
            if(!name || !gid) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");

            if(currentAddType === 'wishlist') {
                await _supabase.from('gifts').insert([{ item_name: name, amount: parseInt(amount)||0, group_id: gid, creator_id: currentUser.id }]);
            } else {
                const target = document.getElementById('add-target-member').value;
                if(!target) return alert("è«‹é¸æ“‡å€Ÿè²¸å°è±¡");
                await _supabase.from('ledgers').insert([{ description: name, amount: parseInt(amount)||0, group_id: gid, creditor_id: currentUser.id, debtor_id: target }]);
            }
            alert("ç™¼ä½ˆæˆåŠŸ");
            closeModal();
            renderContent();
        }

        // è¼”åŠ©å‡½å¼
        function openAddModal() { document.getElementById('add-modal').classList.add('open'); }
        function closeModal() { document.getElementById('add-modal').classList.remove('open'); }
        
        function setAddType(t) {
            currentAddType = t;
            document.getElementById('type-wish').className = t==='wishlist' ? 'flex-1 py-3 rounded-xl text-xs font-bold bg-white text-indigo-600 shadow-sm transition-all' : 'flex-1 py-3 rounded-xl text-xs font-bold text-slate-400 transition-all';
            document.getElementById('type-debt').className = t!=='wishlist' ? 'flex-1 py-3 rounded-xl text-xs font-bold bg-white text-indigo-600 shadow-sm transition-all' : 'flex-1 py-3 rounded-xl text-xs font-bold text-slate-400 transition-all';
            document.getElementById('debt-options').classList.toggle('hidden', t==='wishlist');
            if(t!=='wishlist') loadGroupMembers(document.getElementById('add-group-id').value);
        }

        async function loadGroupsToSelect() {
            const { data } = await _supabase.from('groups').select('*');
            const s = document.getElementById('add-group-id');
            s.innerHTML = '<option value="">é¸æ“‡ç¾¤çµ„</option>';
            data?.forEach(g => s.innerHTML += `<option value="${g.id}">${g.name}</option>`);
        }

        async function loadGroupMembers(gid) {
            if(!gid) return;
            const { data } = await _supabase.from('group_members').select('user_id, profiles(username)').eq('group_id', gid);
            const s = document.getElementById('add-target-member');
            s.innerHTML = '';
            data?.filter(m => m.user_id !== currentUser.id).forEach(m => s.innerHTML += `<option value="${m.user_id}">${m.profiles.username}</option>`);
        }

        function switchTab(t) {
            activeTab = t;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('nav-'+t).classList.add('active');
            renderContent();
        }

        async function handleLogout() { await _supabase.auth.signOut(); window.location.reload(); }
    </script>
</body>
</html>
