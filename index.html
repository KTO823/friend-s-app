<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>GIFTFLOW PRO - å°ˆæ¥­ç¤¾äº¤ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass-morphism { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(15px); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .btn-vibrate:active { transform: scale(0.95); transition: 0.1s; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 overflow-x-hidden">

    <div id="login-screen" class="flex flex-col items-center justify-center min-h-screen p-6">
        <div class="w-full max-w-md bg-white rounded-[3rem] shadow-2xl p-10 text-center border border-slate-100">
            <div class="w-20 h-20 bg-indigo-600 rounded-[2rem] mx-auto mb-8 flex items-center justify-center shadow-lg shadow-indigo-200">
                <i data-lucide="gift" class="text-white w-10 h-10"></i>
            </div>
            <h1 class="text-3xl font-black mb-2 italic">GIFTFLOW</h1>
            <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-10">Professional Group Management</p>
            <form id="login-form" class="space-y-4">
                <input type="email" id="email" placeholder="Email" required class="w-full p-5 bg-slate-50 rounded-2xl outline-none focus:ring-2 ring-indigo-500/20 transition-all">
                <input type="password" id="password" placeholder="Password" required class="w-full p-5 bg-slate-50 rounded-2xl outline-none focus:ring-2 ring-indigo-500/20 transition-all">
                <button type="submit" class="w-full py-5 bg-slate-900 text-white font-black rounded-2xl shadow-xl hover:bg-black transition-all">é€²å…¥ç³»çµ±</button>
            </form>
        </div>
    </div>

    <div id="main-app" class="hidden max-w-md mx-auto min-h-screen flex flex-col">
        <header class="p-6 bg-white/80 backdrop-blur-md sticky top-0 z-50 flex justify-between items-center border-b border-slate-100">
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 bg-indigo-600 rounded-full animate-pulse"></span>
                <h1 class="text-xl font-black italic tracking-tighter">GIFTFLOW</h1>
            </div>
            <button onclick="handleLogout()" class="text-[10px] font-black text-slate-300 uppercase">Sign Out</button>
        </header>

        <main id="content" class="p-6 flex-1 pb-32">
            </main>

        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto glass-morphism border-t border-slate-100 px-8 pt-4 pb-8 flex justify-between items-center z-50 safe-bottom">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="flex flex-col items-center gap-1 opacity-40"><i data-lucide="calendar"></i><span class="text-[10px] font-bold">å€’æ•¸</span></button>
            <button onclick="switchTab('gifts')" id="nav-gifts" class="flex flex-col items-center gap-1 opacity-40"><i data-lucide="package"></i><span class="text-[10px] font-bold">é¡˜æœ›</span></button>
            <div class="relative -top-8">
                <button onclick="openAddModal()" class="bg-indigo-600 text-white p-5 rounded-full shadow-2xl shadow-indigo-300 ring-8 ring-white btn-vibrate"><i data-lucide="plus"></i></button>
            </div>
            <button onclick="switchTab('debts')" id="nav-debts" class="flex flex-col items-center gap-1 opacity-40"><i data-lucide="landmark"></i><span class="text-[10px] font-bold">å¸³å‹™</span></button>
            <button onclick="switchTab('settings')" id="nav-settings" class="flex flex-col items-center gap-1 opacity-40"><i data-lucide="settings"></i><span class="text-[10px] font-bold">è¨­å®š</span></button>
        </nav>
    </div>

    <div id="add-modal" class="hidden fixed inset-0 z-[100] bg-slate-900/40 backdrop-blur-sm flex items-end justify-center">
        <div class="bg-white w-full max-w-md rounded-t-[3.5rem] p-10 shadow-2xl animate-in slide-in-from-bottom duration-300">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-black">æ–°å¢ç´€éŒ„</h2>
                <button onclick="closeModal()" class="p-3 bg-slate-50 rounded-2xl"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>

            <div class="flex p-1 bg-slate-100 rounded-[1.5rem] mb-8">
                <button onclick="setAddType('wishlist')" id="btn-wish" class="flex-1 py-3 rounded-[1.2rem] text-xs font-black bg-white shadow-sm text-indigo-600 transition-all">ğŸ é¡˜æœ›æ¸…å–®</button>
                <button onclick="setAddType('debt')" id="btn-debt" class="flex-1 py-3 rounded-[1.2rem] text-xs font-black text-slate-400 transition-all">ğŸ’¸ å‚µå‹™ç¢ºèª</button>
            </div>

            <form id="add-form" class="space-y-4">
                <input type="text" id="add-name" placeholder="é …ç›®åç¨± (ä¾‹å¦‚: è—ç‰™è€³æ©Ÿ / æ™šé¤ä»£å¢Š)" required class="w-full p-5 bg-slate-50 rounded-2xl outline-none border border-slate-100 focus:border-indigo-600 transition-all">
                <div class="flex gap-4">
                    <input type="number" id="add-price" placeholder="é‡‘é¡" class="flex-1 p-5 bg-slate-50 rounded-2xl outline-none">
                    <select id="add-group-id" class="flex-1 p-5 bg-slate-50 rounded-2xl outline-none font-bold text-sm text-indigo-600" required>
                        <option value="">é¸æ“‡ç¾¤çµ„ *</option>
                    </select>
                </div>
                <button type="button" onclick="handleSubmit()" class="w-full py-5 bg-indigo-600 text-white font-black rounded-2xl shadow-xl shadow-indigo-100 btn-vibrate mt-4">ç™¼ä½ˆç´€éŒ„</button>
            </form>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://kzzxyyykpiquanxtfkwr.supabase.co'; 
        const supabaseKey = 'sb_publishable_K0ThQ9_ZqPPYk0sxxWgLhg_qwzuMNeG'; 
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let activeTab = 'dashboard';
        let currentAddType = 'wishlist';

        window.onload = async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) { currentUser = session.user; showApp(); }
            lucide.createIcons();
        };

        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            switchTab('dashboard');
            loadGroupsToSelect();
        }

        async function renderContent() {
            const container = document.getElementById('content');
            container.innerHTML = '<div class="flex items-center justify-center py-20"><div class="w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div></div>';

            if (activeTab === 'dashboard') {
                // ç”Ÿæ—¥å€’æ•¸ï¼šå¾ Profiles æŠ“å–ä¸¦è¨ˆç®—
                const { data: members } = await _supabase.from('group_members').select('*, profiles(*)');
                const sorted = (members || []).map(m => ({
                    ...m,
                    days: calculateDays(m.profiles?.birthday)
                })).sort((a, b) => a.days - b.days);

                container.innerHTML = `
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-2xl font-black">ğŸ“… å¥½å‹å€’æ•¸</h2>
                        <button class="text-[10px] font-black text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full uppercase">Ranking</button>
                    </div>
                    <div class="space-y-4">
                        ${sorted.length ? sorted.map(m => `
                            <div class="bg-white p-6 rounded-[2.5rem] border border-slate-100 flex justify-between items-center shadow-sm">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-slate-900 text-white rounded-full flex items-center justify-center font-black">${(m.nickname || m.profiles?.username || 'U')[0]}</div>
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <p class="font-bold">${m.nickname || m.profiles?.username || 'åŒ¿åä½¿ç”¨è€…'}</p>
                                            <button onclick="editNickname('${m.id}')" class="text-slate-200"><i data-lucide="edit-3" class="w-3 h-3"></i></button>
                                        </div>
                                        <button onclick="syncCalendar('${m.nickname}', '${m.profiles?.birthday}')" class="text-[9px] font-black text-slate-300 uppercase flex items-center gap-1"><i data-lucide="calendar-plus" class="w-2 h-2"></i> Sync to Calendar</button>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-2xl font-black text-indigo-600">${m.days}<span class="text-[10px] ml-1 opacity-30">å¤©</span></p>
                                </div>
                            </div>
                        `).join('') : '<div class="py-20 text-center opacity-20 font-black italic">NO FRIENDS FOUND</div>'}
                    </div>
                `;
            } else if (activeTab === 'gifts') {
                // é¡˜æœ›æ¸…å–®ï¼šé¡¯ç¤ºèªé ˜æ©Ÿåˆ¶
                const { data: gifts } = await _supabase.from('gifts').select('*');
                container.innerHTML = `
                    <h2 class="text-2xl font-black mb-8">ğŸ é¡˜æœ›ä¿å¯†å®¤</h2>
                    <div class="grid grid-cols-1 gap-4">
                        ${(gifts || []).map(g => `
                            <div class="bg-white p-6 rounded-[2.5rem] border border-slate-100 flex justify-between items-center">
                                <div>
                                    <p class="font-bold text-slate-800">${g.item_name}</p>
                                    <p class="text-xs font-bold text-indigo-600 tracking-tighter">$ ${g.amount.toLocaleString()}</p>
                                </div>
                                ${g.creator_id === currentUser.id 
                                    ? `<span class="text-[10px] font-black px-4 py-2 bg-slate-50 text-slate-300 rounded-full uppercase tracking-tighter">Your Wish</span>`
                                    : g.claimant_id 
                                        ? `<span class="text-[10px] font-black px-4 py-2 bg-indigo-50 text-indigo-600 rounded-full uppercase tracking-tighter">Claimed</span>`
                                        : `<button onclick="claimGift('${g.id}')" class="text-[10px] font-black px-4 py-2 bg-slate-900 text-white rounded-full uppercase tracking-tighter btn-vibrate">Claim Now</button>`
                                }
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (activeTab === 'debts') {
                // å°ˆæ¥­å¸³å‹™ï¼šé›™å‘ç¢ºèª
                const { data: debts } = await _supabase.from('debts').select('*, creditor:creditor_id(username), debtor:debtor_id(username)');
                container.innerHTML = `
                    <h2 class="text-2xl font-black mb-8">ğŸ’¸ å¸³å‹™å°å¸³å–®</h2>
                    <div class="space-y-4">
                        ${(debts || []).map(d => `
                            <div class="bg-white p-6 rounded-[2.5rem] border ${d.is_confirmed ? 'border-slate-100' : 'border-amber-200 bg-amber-50/20'} flex justify-between items-center">
                                <div>
                                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${d.description || 'ç„¡æè¿°'}</p>
                                    <p class="font-bold text-sm">${d.creditor_id === currentUser.id ? 'æ‡‰æ”¶' : 'æ‡‰ä»˜'} <span class="${d.creditor_id === currentUser.id ? 'text-emerald-600' : 'text-rose-600'}">$ ${d.amount}</span></p>
                                </div>
                                ${!d.is_confirmed && d.debtor_id === currentUser.id 
                                    ? `<button onclick="confirmDebt('${d.id}')" class="text-[10px] font-black px-4 py-2 bg-amber-500 text-white rounded-full uppercase">Confirm</button>`
                                    : `<span class="text-[10px] font-black uppercase text-slate-300">${d.is_confirmed ? 'Verified' : 'Pending'}</span>`
                                }
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            lucide.createIcons();
        }

        // åŠŸèƒ½é‚è¼¯
        async function claimGift(id) {
            if (!confirm("èªé ˜å¾Œå…¶ä»–äººå°‡ç„¡æ³•èªé ˜ï¼Œä¸”é¡˜æœ›ä¸»äººæœƒä¿æŒé©šå–œï¼Œç¢ºå®šå—ï¼Ÿ")) return;
            const { error } = await _supabase.from('gifts').update({ claimant_id: currentUser.id }).eq('id', id);
            if (!error) { triggerVibrate(); renderContent(); }
        }

        async function confirmDebt(id) {
            const { error } = await _supabase.from('debts').update({ is_confirmed: true }).eq('id', id);
            if (!error) { triggerVibrate(); renderContent(); }
        }

        function triggerVibrate() { if (window.navigator.vibrate) window.navigator.vibrate(50); }

        function calculateDays(dateStr) {
            if (!dateStr) return 999;
            const today = new Date();
            const bday = new Date(dateStr);
            bday.setFullYear(today.getFullYear());
            if (bday < today) bday.setFullYear(today.getFullYear() + 1);
            return Math.ceil((bday - today) / (1000 * 60 * 60 * 24));
        }

        function syncCalendar(name, bday) {
            const [m, d] = bday.split('-');
            const year = new Date().getFullYear();
            const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(name + ' ç”Ÿæ—¥é©šå–œæº–å‚™')}&dates=${year}${m}${d}/${year}${m}${d}`;
            window.open(url, '_blank');
        }

        async function handleSubmit() {
            const name = document.getElementById('add-name').value;
            const price = document.getElementById('add-price').value;
            const group = document.getElementById('add-group-id').value;
            
            if (!name || !group) return alert("è«‹å¡«å¯«åç¨±ä¸¦é¸æ“‡ç¾¤çµ„");

            let error;
            if (currentAddType === 'wishlist') {
                const res = await _supabase.from('gifts').insert([{ item_name: name, amount: parseInt(price) || 0, group_id: group, creator_id: currentUser.id }]);
                error = res.error;
            } else {
                // é€™è£¡ç°¡åŒ–ç‚ºç™¼èµ·è€…æ˜¯å‚µæ¬Šäººï¼Œå¯¦éš›æ‡‰ç”¨å¯å¢åŠ é¸æ“‡èª°æ¬ èª°
                const res = await _supabase.from('debts').insert([{ description: name, amount: parseFloat(price), group_id: group, creditor_id: currentUser.id, debtor_id: 'éœ€å¡«å…¥å°æ–¹ID' }]);
                error = res.error;
            }

            if (!error) { triggerVibrate(); closeModal(); renderContent(); }
        }

        function switchTab(tab) {
            activeTab = tab;
            document.querySelectorAll('nav button').forEach(b => b.classList.add('opacity-40'));
            document.getElementById('nav-' + tab).classList.remove('opacity-40');
            renderContent();
        }

        function setAddType(type) {
            currentAddType = type;
            const isWish = type === 'wishlist';
            document.getElementById('btn-wish').className = isWish ? 'flex-1 py-3 rounded-[1.2rem] text-xs font-black bg-white shadow-sm text-indigo-600 transition-all' : 'flex-1 py-3 rounded-[1.2rem] text-xs font-black text-slate-400 transition-all';
            document.getElementById('btn-debt').className = !isWish ? 'flex-1 py-3 rounded-[1.2rem] text-xs font-black bg-white shadow-sm text-indigo-600 transition-all' : 'flex-1 py-3 rounded-[1.2rem] text-xs font-black text-slate-400 transition-all';
        }

        async function loadGroupsToSelect() {
            const { data } = await _supabase.from('groups').select('*');
            const select = document.getElementById('add-group-id');
            if (data && select) {
                select.innerHTML = '<option value="">é¸æ“‡ç¾¤çµ„ *</option>';
                data.forEach(g => select.innerHTML += `<option value="${g.id}">${g.name}</option>`);
            }
        }

        function openAddModal() { document.getElementById('add-modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('add-modal').classList.add('hidden'); }
        async function handleLogout() { await _supabase.auth.signOut(); window.location.reload(); }

        document.getElementById('login-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
            if (!error) { currentUser = data.user; showApp(); }
        };
    </script>
</body>
</html>
