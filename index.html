<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>GIFTFLOW PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(241, 245, 249, 0.5); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .settings-item { @apply flex items-center justify-between p-4 bg-white border-b border-slate-50 last:border-0 active:bg-slate-50 transition-colors cursor-pointer; }
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(15, 23, 42, 0.9); color: white; padding: 10px 24px; border-radius: 99px; font-size: 13px; font-weight: bold; opacity: 0; transition: opacity 0.3s, transform 0.3s; pointer-events: none; z-index: 9999; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.3); white-space: nowrap; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
        .btn-press:active { transform: scale(0.96); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 overflow-x-hidden select-none">

    <div id="toast" class="toast">Action Successful</div>

    <div id="login-screen" class="flex flex-col items-center justify-center min-h-screen p-6 relative z-50 bg-slate-50">
        <div class="w-full max-w-md bg-white rounded-[2.5rem] shadow-2xl p-10 text-center border border-slate-100/50">
            <div class="w-16 h-16 bg-indigo-600 rounded-2xl mx-auto mb-6 flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                <i data-lucide="gift" class="w-8 h-8"></i>
            </div>
            <h1 class="text-2xl font-black mb-2 tracking-tight">GIFTFLOW</h1>
            <p class="text-xs font-bold text-slate-400 mb-8 uppercase tracking-widest">Social Wishlist & Ledger</p>
            <form id="login-form" class="space-y-4 text-left">
                <input type="email" id="email" placeholder="Email" required class="w-full p-4 bg-slate-50 rounded-2xl outline-none border border-transparent focus:bg-white focus:border-indigo-600 transition-all font-bold text-sm">
                <input type="password" id="password" placeholder="Password" required class="w-full p-4 bg-slate-50 rounded-2xl outline-none border border-transparent focus:bg-white focus:border-indigo-600 transition-all font-bold text-sm">
                <button type="submit" class="w-full py-4 bg-slate-900 text-white font-bold rounded-2xl shadow-xl mt-4 btn-press transition-transform">é–‹å§‹ä½¿ç”¨</button>
            </form>
        </div>
    </div>

    <div id="main-app" class="hidden max-w-md mx-auto min-h-screen flex flex-col">
        <header class="px-6 py-4 sticky top-0 z-40 flex justify-between items-center glass">
            <div class="flex items-center gap-2" onclick="switchTab('dashboard')">
                <h1 class="text-xl font-black italic text-indigo-600 tracking-tighter cursor-pointer">GIFTFLOW</h1>
            </div>
            <button onclick="switchTab('settings')" class="relative group btn-press">
                <div id="header-avatar" class="w-9 h-9 rounded-full bg-slate-200 overflow-hidden border-2 border-white shadow-sm ring-2 ring-slate-100 transition-all"></div>
            </button>
        </header>

        <main id="content" class="p-6 flex-1 pb-32 overflow-y-auto hide-scrollbar">
            </main>

        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto glass border-t border-slate-100 px-8 pt-4 pb-8 flex justify-between items-center z-40 safe-bottom">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="flex flex-col items-center gap-1 opacity-30 transition-opacity"><i data-lucide="calendar-days"></i><span class="text-[10px] font-bold">å€’æ•¸</span></button>
            <button onclick="switchTab('gifts')" id="nav-gifts" class="flex flex-col items-center gap-1 opacity-30 transition-opacity"><i data-lucide="gift"></i><span class="text-[10px] font-bold">é¡˜æœ›</span></button>
            <div class="relative -top-8">
                <button onclick="openAddModal()" class="bg-indigo-600 text-white p-5 rounded-full shadow-xl shadow-indigo-300 ring-8 ring-white btn-press transition-transform"><i data-lucide="plus" class="w-7 h-7"></i></button>
            </div>
            <button onclick="switchTab('ledgers')" id="nav-ledgers" class="flex flex-col items-center gap-1 opacity-30 transition-opacity"><i data-lucide="wallet"></i><span class="text-[10px] font-bold">å°å¸³</span></button>
            <button onclick="switchTab('settings')" id="nav-settings" class="flex flex-col items-center gap-1 opacity-30 transition-opacity"><i data-lucide="user-circle"></i><span class="text-[10px] font-bold">æˆ‘çš„</span></button>
        </nav>
    </div>

    <div id="add-modal" class="hidden fixed inset-0 z-50 bg-slate-900/60 backdrop-blur-sm flex items-end justify-center sm:items-center p-0 sm:p-4 transition-opacity duration-300">
        <div class="bg-white w-full max-w-md rounded-t-[2.5rem] sm:rounded-[2.5rem] p-8 shadow-2xl animate-in slide-in-from-bottom duration-300">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black text-slate-800">New Item</h2>
                <button onclick="closeModal()" class="p-2 bg-slate-50 rounded-full hover:bg-slate-100"><i data-lucide="x" class="w-5 h-5 text-slate-500"></i></button>
            </div>
            
            <div class="flex p-1.5 bg-slate-100 rounded-2xl mb-6">
                <button onclick="setAddType('wishlist')" id="type-wish" class="flex-1 py-3 rounded-xl text-xs font-black bg-white shadow-sm text-indigo-600 transition-all">ğŸ é¡˜æœ›</button>
                <button onclick="setAddType('debt')" id="type-debt" class="flex-1 py-3 rounded-xl text-xs font-black text-slate-400 transition-all">ğŸ’¸ è¨˜å¸³</button>
            </div>

            <form id="add-form" class="space-y-4">
                <input type="text" id="add-name" placeholder="é …ç›®åç¨± (å¦‚: æ™šé¤ã€AirPods)" required class="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold text-sm focus:ring-2 ring-indigo-100 transition-all">
                
                <div class="flex gap-3">
                    <input type="number" id="add-amount" placeholder="é‡‘é¡" class="flex-1 p-4 bg-slate-50 rounded-2xl outline-none font-bold text-sm focus:ring-2 ring-indigo-100 transition-all">
                    <select id="add-priority" class="flex-1 p-4 bg-slate-50 rounded-2xl outline-none font-bold text-xs text-slate-600">
                        <option value="normal">æ¬Šé‡: ä¸€èˆ¬</option>
                        <option value="high">ğŸ”¥ æ¥µåº¦æƒ³è¦</option>
                        <option value="low">â˜• éš¨ç·£</option>
                    </select>
                </div>

                <select id="add-group-id" class="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold text-sm text-indigo-600 bg-indigo-50/50" onchange="loadGroupMembersForDebt(this.value)"></select>

                <div id="debt-options" class="hidden space-y-3 pt-2">
                    <div class="flex gap-2 text-[10px] font-bold text-slate-400 uppercase tracking-wider px-2">å€Ÿè²¸æ–¹å‘</div>
                    <div class="flex gap-2">
                        <button type="button" onclick="setDebtDirection('owe_me')" id="dir-owe-me" class="flex-1 py-3 border-2 border-indigo-600 bg-indigo-50 text-indigo-700 rounded-xl text-xs font-bold transition-all">åˆ¥äººæ¬ æˆ‘</button>
                        <button type="button" onclick="setDebtDirection('i_owe')" id="dir-i-owe" class="flex-1 py-3 border-2 border-slate-100 text-slate-400 rounded-xl text-xs font-bold transition-all">æˆ‘æ¬ åˆ¥äºº</button>
                    </div>
                    <select id="add-target-member" class="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold text-sm text-slate-700"></select>
                </div>

                <button type="button" onclick="handleSubmit()" class="w-full py-4 bg-slate-900 text-white font-bold rounded-2xl shadow-xl mt-4 btn-press transition-transform">ç™¼ä½ˆç´€éŒ„</button>
            </form>
        </div>
    </div>

    <script>
        // è¨­å®š Supabase
        const supabaseUrl = 'https://kzzxyyykpiquanxtfkwr.supabase.co'; 
        const supabaseKey = 'sb_publishable_K0ThQ9_ZqPPYk0sxxWgLhg_qwzuMNeG'; 
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let activeTab = 'dashboard';
        let currentAddType = 'wishlist';
        let debtDirection = 'owe_me'; // owe_me (åˆ¥äººæ¬ æˆ‘), i_owe (æˆ‘æ¬ åˆ¥äºº)

        // 1. åˆå§‹åŒ–èˆ‡ç™»å…¥æª¢æŸ¥
        window.onload = async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) { 
                currentUser = session.user; 
                showApp(); 
            }
            lucide.createIcons();
        };

        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            updateHeaderAvatar();
            switchTab('dashboard');
            loadGroupsToSelect();
        }

        // 2. æ ¸å¿ƒæ¸²æŸ“é‚è¼¯
        async function renderContent() {
            const container = document.getElementById('content');
            
            if (activeTab === 'dashboard') {
                container.innerHTML = '<div class="py-10 text-center"><div class="w-6 h-6 border-2 border-slate-200 border-t-indigo-600 rounded-full animate-spin mx-auto"></div></div>';
                
                // ç”Ÿæ—¥å€’æ•¸ï¼šéæ¿¾æ‰è‡ªå·±
                const { data: members } = await _supabase.from('group_members').select('*, profiles(*)');
                if (!members || members.length === 0) return renderEmpty('å°šç„¡å¥½å‹', 'å»è¨­å®šé é¢å»ºç«‹ç¾¤çµ„å§ï¼');

                // éæ¿¾è‡ªå·±ä¸¦æ’åº
                const sorted = members
                    .filter(m => m.user_id !== currentUser.id)
                    .map(m => ({ ...m, days: calculateDays(m.profiles?.birthday) }))
                    .sort((a, b) => a.days - b.days);

                if (sorted.length === 0) return renderEmpty('åªæœ‰ä½ è‡ªå·±', 'é‚€è«‹æœ‹å‹åŠ å…¥ç¾¤çµ„å§ï¼');

                container.innerHTML = `
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-black text-slate-800">Upcoming Birthdays</h2>
                        <span class="text-[10px] font-bold bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full">SORTED</span>
                    </div>
                    <div class="space-y-3">
                        ${sorted.map(m => `
                            <div class="bg-white p-4 rounded-[1.5rem] shadow-sm border border-slate-100 flex justify-between items-center group active:scale-[0.98] transition-transform duration-200">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-slate-100 rounded-full overflow-hidden">
                                        <img src="${m.profiles?.avatar_url || `https://api.dicebear.com/9.x/avataaars/svg?seed=${m.profiles?.username || 'User'}`}" class="w-full h-full object-cover">
                                    </div>
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <p class="font-bold text-sm text-slate-800">${m.nickname || m.profiles?.username || 'Friend'}</p>
                                        </div>
                                        <button onclick="syncCalendar('${m.nickname || m.profiles?.username}', '${m.profiles?.birthday}')" class="text-[10px] font-bold text-indigo-400 uppercase tracking-tight flex items-center gap-1 hover:text-indigo-600">
                                            <i data-lucide="calendar-plus" class="w-3 h-3"></i> Add to Calendar
                                        </button>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-xl font-black text-indigo-600">${m.days}<span class="text-[10px] ml-0.5 text-slate-400 font-bold">DAYS</span></p>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;

            } else if (activeTab === 'gifts') {
                container.innerHTML = '<div class="py-10 text-center"><div class="w-6 h-6 border-2 border-slate-200 border-t-indigo-600 rounded-full animate-spin mx-auto"></div></div>';
                // é¡˜æœ›æ¸…å–® (æ–°å¢ created_at æ’åº)
                const { data: gifts } = await _supabase.from('gifts').select('*').order('created_at', { ascending: false });
                if (!gifts || gifts.length === 0) return renderEmpty('é¡˜æœ›æ¸…å–®æ˜¯ç©ºçš„', 'æ–°å¢ä¸€å€‹é¡˜æœ›ï¼Œè®“æœ‹å‹çµ¦ä½ é©šå–œï¼');

                container.innerHTML = `
                    <h2 class="text-xl font-black text-slate-800 mb-6">Wishlist</h2>
                    <div class="grid grid-cols-1 gap-3">
                        ${gifts.map(g => {
                            const isMine = g.creator_id === currentUser.id;
                            return `
                            <div class="bg-white p-5 rounded-[1.5rem] border border-slate-100 shadow-sm flex justify-between items-center">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <p class="font-bold text-slate-800 text-sm">${g.item_name}</p>
                                        ${g.priority === 'high' ? '<span class="text-[8px] bg-rose-50 text-rose-500 px-2 py-0.5 rounded-full font-black tracking-wider">HOT</span>' : ''}
                                    </div>
                                    <p class="text-xs font-bold text-slate-400 mt-0.5">$ ${g.amount.toLocaleString()}</p>
                                </div>
                                <div>
                                    ${isMine ? 
                                        `<span class="text-[10px] font-bold text-slate-300 bg-slate-50 px-3 py-1.5 rounded-full">${g.is_reserved ? 'å·²è¢«èªé ˜ ğŸ¤«' : 'ç­‰å¾…ä¸­'}</span>` : 
                                        (g.is_reserved ? 
                                            `<span class="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-3 py-1.5 rounded-full flex items-center gap-1"><i data-lucide="check" class="w-3 h-3"></i> å·²èªé ˜</span>` : 
                                            `<button onclick="reserveGift('${g.id}', this)" class="text-[10px] font-bold bg-slate-900 text-white px-4 py-2 rounded-full active:scale-95 transition-transform">èªé ˜</button>`
                                        )
                                    }
                                </div>
                            </div>`;
                        }).join('')}
                    </div>`;

            } else if (activeTab === 'ledgers') {
                container.innerHTML = '<div class="py-10 text-center"><div class="w-6 h-6 border-2 border-slate-200 border-t-indigo-600 rounded-full animate-spin mx-auto"></div></div>';
                // å¸³å‹™ (æ–°å¢ created_at æ’åº)
                const { data: ledgers } = await _supabase.from('ledgers').select('*, creditor:profiles!creditor_id(username), debtor:profiles!debtor_id(username)').order('created_at', { ascending: false });
                
                if (!ledgers || ledgers.length === 0) return renderEmpty('æ²’æœ‰å¸³å‹™ç´€éŒ„', 'å¥½æœ‹å‹æ˜ç®—å¸³ï¼Œç´€éŒ„ç¬¬ä¸€ç­†å§ï¼');

                container.innerHTML = `
                    <h2 class="text-xl font-black text-slate-800 mb-6">Ledgers</h2>
                    <div class="space-y-3">
                        ${ledgers.map(l => {
                            const isMeCreditor = l.creditor_id === currentUser.id; // æˆ‘æ˜¯å‚µæ¬Šäºº (æˆ‘æ”¶éŒ¢)
                            const otherName = isMeCreditor ? (l.debtor?.username || 'å°æ–¹') : (l.creditor?.username || 'å°æ–¹');
                            return `
                            <div class="bg-white p-5 rounded-[1.5rem] border ${l.status==='pending' ? 'border-amber-200 bg-amber-50/10' : 'border-slate-100'} flex justify-between items-center">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">${l.description || 'ä¸€èˆ¬å¸³å‹™'}</p>
                                        ${l.status === 'pending' ? '<span class="w-1.5 h-1.5 bg-amber-400 rounded-full"></span>' : ''}
                                    </div>
                                    <p class="font-bold text-sm flex items-center gap-1">
                                        <span class="${isMeCreditor ? 'text-emerald-600' : 'text-rose-500'}">${isMeCreditor ? 'æ”¶' : 'ä»˜'}</span>
                                        <span class="text-slate-700">${otherName}</span>
                                        <span class="text-slate-900 ml-1">$${l.amount}</span>
                                    </p>
                                </div>
                                ${l.status === 'pending' && !isMeCreditor ? 
                                    `<button onclick="confirmLedger('${l.id}', this)" class="text-[10px] font-bold bg-emerald-500 text-white px-4 py-2 rounded-full shadow-sm shadow-emerald-200 active:scale-95 transition-transform">ç¢ºèª</button>` : 
                                    `<span class="text-[10px] font-bold ${l.status==='confirmed' ? 'text-emerald-600 bg-emerald-50' : 'text-amber-500 bg-amber-50'} px-3 py-1 rounded-full">${l.status}</span>`
                                }
                            </div>`
                        }).join('')}
                    </div>`;

            } else if (activeTab === 'settings') {
                // iOS é¢¨æ ¼è¨­å®šé 
                const { data: profile } = await _supabase.from('profiles').select('*').eq('id', currentUser.id).single();
                const { data: myGroups } = await _supabase.from('groups').select('*');
                
                // DiceBear é ­åƒç¨®å­
                const avatarUrl = profile?.avatar_url || `https://api.dicebear.com/9.x/avataaars/svg?seed=${profile?.username || currentUser.email}`;

                container.innerHTML = `
                    <div class="flex flex-col items-center mb-8 pt-4">
                        <div class="relative mb-4 group cursor-pointer" onclick="promptAvatar()">
                            <div class="w-24 h-24 rounded-full bg-slate-100 p-1 shadow-lg border border-slate-100 overflow-hidden relative">
                                <img src="${avatarUrl}" class="w-full h-full rounded-full object-cover bg-white">
                                <div class="absolute inset-0 bg-black/30 hidden group-hover:flex items-center justify-center rounded-full text-white text-xs font-bold">æ›´æ›</div>
                            </div>
                            <button class="absolute bottom-0 right-0 bg-indigo-600 text-white p-2 rounded-full border-4 border-slate-50 shadow-sm"><i data-lucide="camera" class="w-3 h-3"></i></button>
                        </div>
                        <h2 class="text-xl font-black text-slate-900">${profile?.username || 'æœªè¨­å®šæš±ç¨±'}</h2>
                        <p class="text-xs font-bold text-slate-400 mb-4">${currentUser.email}</p>
                        
                        <div class="flex gap-2">
                            <button onclick="openEditProfile('${profile?.username || ''}', '${profile?.birthday || ''}')" class="px-5 py-2 bg-slate-900 text-white text-xs font-bold rounded-full shadow-lg active:scale-95 transition-transform">ç·¨è¼¯è³‡æ–™</button>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="px-4 text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">My Groups</h3>
                        <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden">
                            ${myGroups && myGroups.length > 0 ? myGroups.map(g => `
                                <div class="settings-item group">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center font-black text-xs">#</div>
                                        <span class="font-bold text-sm text-slate-700">${g.name}</span>
                                    </div>
                                    <button onclick="copyInviteCode('${g.invite_code}')" class="px-3 py-1.5 bg-slate-50 text-slate-500 rounded-lg text-[10px] font-bold group-active:bg-indigo-600 group-active:text-white transition-colors">è¤‡è£½é‚€è«‹ç¢¼</button>
                                </div>
                            `).join('') : '<div class="p-6 text-center text-xs text-slate-300 italic">å°šæœªåŠ å…¥ä»»ä½•ç¾¤çµ„</div>'}
                            
                            <div class="p-2 flex gap-2 bg-slate-50/50">
                                <button onclick="openGroupModal('create')" class="flex-1 py-3 bg-white border border-slate-200 rounded-xl text-xs font-bold text-indigo-600 shadow-sm btn-press">å»ºç«‹æ–°ç¾¤çµ„</button>
                                <button onclick="openGroupModal('join')" class="flex-1 py-3 bg-white border border-slate-200 rounded-xl text-xs font-bold text-slate-600 shadow-sm btn-press">åŠ å…¥ç¾¤çµ„</button>
                            </div>
                        </div>
                    </div>

                    <div class="mb-8">
                        <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden">
                            <button onclick="handleLogout()" class="settings-item w-full text-rose-500 hover:bg-rose-50">
                                <div class="flex items-center gap-3"><i data-lucide="log-out" class="w-4 h-4"></i><span class="text-sm font-bold">ç™»å‡ºå¸³è™Ÿ</span></div>
                            </button>
                        </div>
                    </div>
                    <p class="text-center text-[10px] font-bold text-slate-300 pb-8">GIFTFLOW PRO v2.0</p>
                `;
            }
            lucide.createIcons();
        }

        // --- åŠŸèƒ½é‚è¼¯ ---

        // 1. ç·¨è¼¯è³‡æ–™
        async function openEditProfile(oldName, oldBday) {
            const newName = prompt("è«‹è¼¸å…¥æ–°çš„æš±ç¨±ï¼š", oldName);
            if (newName === null) return;
            const newBday = prompt("è«‹è¼¸å…¥ç”Ÿæ—¥ (YYYY-MM-DD)ï¼š", oldBday);
            if (newBday === null) return;
            const { error } = await _supabase.from('profiles').update({ username: newName, birthday: newBday }).eq('id', currentUser.id);
            if (!error) { showToast("è³‡æ–™å·²æ›´æ–°ï¼"); renderContent(); updateHeaderAvatar(); }
            else showToast(error.message);
        }

        // 2. æ›´æ›é ­åƒ
        async function promptAvatar() {
            const url = prompt("è«‹è¼¸å…¥åœ–ç‰‡é€£çµ (JPG/PNG)ï¼Œæˆ–ç•™ç©ºä½¿ç”¨è‡ªå‹•ç”Ÿæˆé ­åƒï¼š");
            if (url === null) return;
            const updateVal = url.trim() === "" ? null : url;
            const { error } = await _supabase.from('profiles').update({ avatar_url: updateVal }).eq('id', currentUser.id);
            if (!error) { showToast("é ­åƒå·²æ›´æ–°"); renderContent(); updateHeaderAvatar(); }
            else showToast(error.message);
        }

        // 3. æ›´æ–° Header é ­åƒ
        async function updateHeaderAvatar() {
            const { data: profile } = await _supabase.from('profiles').select('avatar_url, username').eq('id', currentUser.id).single();
            const url = profile?.avatar_url || `https://api.dicebear.com/9.x/avataaars/svg?seed=${profile?.username || currentUser.email}`;
            document.getElementById('header-avatar').innerHTML = `<img src="${url}" class="w-full h-full object-cover">`;
        }

        // 4. å³æ™‚èªé ˜ (Optimistic UI)
        async function reserveGift(id, btn) {
            btn.innerText = "...";
            const { error } = await _supabase.from('gifts').update({ is_reserved: true, reserved_by: currentUser.id }).eq('id', id);
            if (!error) { 
                showToast("èªé ˜æˆåŠŸï¼åˆ¥å¿˜äº†æº–å‚™é©šå–œ"); 
                renderContent(); // é‡æ–°æ•´ç†åˆ—è¡¨
            } else showToast("æ“ä½œå¤±æ•—");
        }

        // 5. å³æ™‚ç¢ºèªå¸³å‹™
        async function confirmLedger(id, btn) {
            btn.innerText = "...";
            const { error } = await _supabase.from('ledgers').update({ status: 'confirmed' }).eq('id', id);
            if (!error) { showToast("å¸³å‹™å·²ç¢ºèª"); renderContent(); }
        }

        // 6. æ—¥æ›†åŒæ­¥ (ä¿®å¾©å¹´ä»½ Bug)
        function syncCalendar(name, bday) {
            if (!bday) return showToast("å°æ–¹æœªè¨­å®šç”Ÿæ—¥");
            const today = new Date();
            const [y, m, d] = bday.split('-');
            let nextYear = today.getFullYear();
            // å¦‚æœä»Šå¹´ç”Ÿæ—¥å·²é (æœˆä»½æ˜¯ 0-indexed)ï¼Œå¹´ä»½+1
            if (new Date(nextYear, m - 1, d) < today) nextYear++;
            const dateStr = `${nextYear}${m}${d}`;
            const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(name + ' ç”Ÿæ—¥')}&dates=${dateStr}/${dateStr}`;
            window.open(url, '_blank');
        }

        // 7. ç¾¤çµ„åŠŸèƒ½
        function openGroupModal(action) {
            if (action === 'create') {
                const name = prompt("è«‹è¼¸å…¥æ–°ç¾¤çµ„åç¨±ï¼š");
                if (name) createGroupLogic(name);
            } else {
                const code = prompt("è«‹è¼¸å…¥ 6 ç¢¼é‚€è«‹ç¢¼ï¼š");
                if (code) joinGroupLogic(code);
            }
        }

        async function createGroupLogic(name) {
            const { data: group, error } = await _supabase.from('groups').insert([{ name, creator_id: currentUser.id }]).select().single();
            if (!error) {
                await _supabase.from('group_members').insert([{ group_id: group.id, user_id: currentUser.id }]);
                showToast("å»ºç«‹æˆåŠŸ"); renderContent(); loadGroupsToSelect();
            } else showToast(error.message);
        }

        async function joinGroupLogic(code) {
            // æª¢æŸ¥æ˜¯å¦å·²åœ¨ç¾¤çµ„ (ç•¥éè¤‡é›œæª¢æŸ¥ï¼Œç›´æ¥ä¾è³´ UNIQUE constraint å ±éŒ¯)
            const { data: group } = await _supabase.from('groups').select('id').eq('invite_code', code).single();
            if (!group) return showToast("é‚€è«‹ç¢¼ç„¡æ•ˆ");
            const { error } = await _supabase.from('group_members').insert([{ group_id: group.id, user_id: currentUser.id }]);
            if (!error) { showToast("æˆåŠŸåŠ å…¥"); renderContent(); loadGroupsToSelect(); }
            else showToast("ä½ å·²ç¶“åœ¨è©²ç¾¤çµ„äº†");
        }

        // 8. æäº¤è¡¨å–® (æ”¯æ´å€Ÿè²¸æ–¹å‘)
        async function handleSubmit() {
            const name = document.getElementById('add-name').value;
            const amount = document.getElementById('add-amount').value;
            const groupId = document.getElementById('add-group-id').value;
            
            if (!name || !groupId) return showToast("è³‡è¨Šä¸å®Œæ•´");

            let error;
            if (currentAddType === 'wishlist') {
                const priority = document.getElementById('add-priority').value;
                const res = await _supabase.from('gifts').insert([{ item_name: name, amount: parseInt(amount)||0, group_id: groupId, priority, creator_id: currentUser.id }]);
                error = res.error;
            } else {
                const targetId = document.getElementById('add-target-member').value;
                if (!targetId) return showToast("è«‹é¸æ“‡å°è±¡");
                
                let creditor, debtor;
                if (debtDirection === 'owe_me') {
                    // åˆ¥äººæ¬ æˆ‘ => æˆ‘æ˜¯å‚µæ¬Šäºº
                    creditor = currentUser.id;
                    debtor = targetId;
                } else {
                    // æˆ‘æ¬ åˆ¥äºº => åˆ¥äººæ˜¯å‚µæ¬Šäºº
                    creditor = targetId;
                    debtor = currentUser.id;
                }

                const res = await _supabase.from('ledgers').insert([{ 
                    description: name, amount: parseInt(amount)||0, group_id: groupId, 
                    creditor_id: creditor, debtor_id: debtor 
                }]);
                error = res.error;
            }

            if (!error) { showToast("ç™¼ä½ˆæˆåŠŸ"); closeModal(); renderContent(); }
            else showToast(error.message);
        }

        // --- UI è¼”åŠ©å‡½å¼ ---

        function renderEmpty(title, desc) {
            return `<div class="flex flex-col items-center justify-center h-full opacity-40 mt-20">
                <i data-lucide="ghost" class="w-12 h-12 mb-4"></i>
                <h3 class="text-lg font-black">${title}</h3>
                <p class="text-xs font-bold">${desc}</p>
            </div>`;
        }

        function setDebtDirection(dir) {
            debtDirection = dir;
            const btnOweMe = document.getElementById('dir-owe-me');
            const btnIOwe = document.getElementById('dir-i-owe');
            
            if (dir === 'owe_me') {
                btnOweMe.className = "flex-1 py-3 border-2 border-indigo-600 bg-indigo-50 text-indigo-700 rounded-xl text-xs font-bold transition-all";
                btnIOwe.className = "flex-1 py-3 border-2 border-slate-100 text-slate-400 rounded-xl text-xs font-bold transition-all";
            } else {
                btnOweMe.className = "flex-1 py-3 border-2 border-slate-100 text-slate-400 rounded-xl text-xs font-bold transition-all";
                btnIOwe.className = "flex-1 py-3 border-2 border-rose-500 bg-rose-50 text-rose-600 rounded-xl text-xs font-bold transition-all";
            }
        }

        function setAddType(t) {
            currentAddType = t;
            const isW = t === 'wishlist';
            document.getElementById('type-wish').className = isW ? 'flex-1 py-3 rounded-xl text-xs font-black bg-white shadow-sm text-indigo-600 transition-all' : 'flex-1 py-3 rounded-xl text-xs font-black text-slate-400 transition-all';
            document.getElementById('type-debt').className = !isW ? 'flex-1 py-3 rounded-xl text-xs font-black bg-white shadow-sm text-indigo-600 transition-all' : 'flex-1 py-3 rounded-xl text-xs font-black text-slate-400 transition-all';
            
            document.getElementById('add-priority').parentElement.classList.toggle('hidden', !isW);
            document.getElementById('debt-options').classList.toggle('hidden', isW);
            
            if (!isW) {
                loadGroupMembersForDebt(document.getElementById('add-group-id').value);
                setDebtDirection('owe_me'); // reset
            }
        }

        async function loadGroupMembersForDebt(groupId) {
            if (currentAddType !== 'debt' || !groupId) return;
            const { data: members } = await _supabase.from('group_members').select('user_id, profiles(username)').eq('group_id', groupId);
            const select = document.getElementById('add-target-member');
            select.innerHTML = '';
            if (members) {
                members.filter(m => m.user_id !== currentUser.id).forEach(m => {
                    select.innerHTML += `<option value="${m.user_id}">${m.profiles?.username || 'User'}</option>`;
                });
            }
        }

        async function loadGroupsToSelect() {
            const { data } = await _supabase.from('groups').select('*');
            const select = document.getElementById('add-group-id');
            if (select) {
                select.innerHTML = '<option value="">é¸æ“‡ç¾¤çµ„</option>';
                if (data) data.forEach(g => select.innerHTML += `<option value="${g.id}">${g.name}</option>`);
            }
        }
        
        function calculateDays(d) {
            if (!d) return 999;
            const t = new Date(), b = new Date(d); b.setFullYear(t.getFullYear());
            if (b < t) b.setFullYear(t.getFullYear() + 1);
            return Math.ceil((b - t) / 864e5);
        }

        function copyInviteCode(c) { navigator.clipboard.writeText(c); showToast("é‚€è«‹ç¢¼å·²è¤‡è£½: " + c); }
        function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
        function switchTab(t) { activeTab = t; document.querySelectorAll('nav button').forEach(b => b.classList.add('opacity-30')); document.getElementById('nav-'+t).classList.remove('opacity-30'); renderContent(); }
        function openAddModal() { document.getElementById('add-modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('add-modal').classList.add('hidden'); }
        async function handleLogout() { await _supabase.auth.signOut(); window.location.reload(); }
        function shareApp() { if(navigator.share) navigator.share({title:'GIFTFLOW', url: window.location.href}); else copyInviteCode(window.location.href); }
        
        document.getElementById('login-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
            if (!error) { currentUser = data.user; showApp(); } else {
                 const res = await _supabase.auth.signUp({ email, password });
                 if(!res.error) showToast("è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥"); else showToast(res.error.message);
            }
        };
    </script>
</body>
</html>
